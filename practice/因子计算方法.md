```python
import numpy as np
import pandas as pd
```


```python
#使用tushare获取数据
import tushare as ts
#设置好你的token
token = 'b15148f5ca285bd0e85bbc3f659daefff549ade3bba06fae6a037f03'
pro = ts.pro_api(token)
```


```python
import time
# 优雅撸数据
def get_daily(ts_code='', trade_date='', start_date='', end_date=''):
    for _ in range(3):
        try:
            if trade_date:
                df = pro.daily(ts_code=ts_code, trade_date=trade_date)
            else:
                df = pro.daily(ts_code=ts_code, start_date=start_date, end_date=end_date)
        except:
                time.sleep(1)
        else:
                return df
```


```python
def get_basic(ts_code='', trade_date='', start_date='', end_date=''):
    for _ in range(3):
        try:
            if trade_date:
                df = pro.daily_basic(ts_code=ts_code, trade_date=trade_date)
            else:
                df = pro.daily_basic(ts_code=ts_code, start_date=start_date, end_date=end_date)
        except:
                time.sleep(1)
        else:
                return df
```


```python
start_date = '20100101'
end_date = '20150501'
```


```python
df_cal = pro.trade_cal(start_date=start_date, end_date=end_date)
# exchange: 交易所 SSE上交所 SZSE深交所
# is_open: 是否交易 0休市 1交易
df_final = pd.DataFrame()

df_cal = df_cal.query('(exchange=="SSE") & (is_open==1)')
for date in df_cal.cal_date:
    df_daily = get_daily(trade_date=date)
    df_basic = get_basic(trade_date=date)
    df = pd.merge(df_daily, df_basic, on='ts_code', how='inner')
    df_final = df_final.append(df)
    print(f'done {date}')
```

    
    done 20130809



```python
df_final = df_final.sort_values(['ts_code', 'trade_date_x'])
```


```python
df_final['BM'] = 1/df_final['pb']
```


```python
df_final.columns
```




    Index(['ts_code', 'trade_date_x', 'open', 'high', 'low', 'close_x',
           'pre_close', 'change', 'pct_chg', 'vol', 'amount', 'trade_date_y',
           'close_y', 'turnover_rate', 'turnover_rate_f', 'volume_ratio', 'pe',
           'pe_ttm', 'pb', 'ps', 'ps_ttm', 'dv_ratio', 'dv_ttm', 'total_share',
           'float_share', 'free_share', 'total_mv', 'circ_mv', 'BM'],
          dtype='object')




```python
cols = ['ts_code', 'trade_date_x', 'pct_chg', 'circ_mv', 'BM']
df_BM = df_final[cols]
```


```python
df_BM.columns = ['ts_code', 'trade_date', 'pct_chg', 'circ_mv', 'BM']
```


```python
df_BM['trade_date'] = pd.to_datetime(df_BM['trade_date'])
```

    <ipython-input-12-1e7f2e8ba934>:1: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      df_BM['trade_date'] = pd.to_datetime(df_BM['trade_date'])



```python
df_BM['pct_chg']/=100
```

    <ipython-input-13-6e7dff4d9ff8>:1: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      df_BM['pct_chg']/=100



```python
df_BM.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 1851261 entries, 419 to 1292
    Data columns (total 5 columns):
     #   Column      Dtype         
    ---  ------      -----         
     0   ts_code     object        
     1   trade_date  datetime64[ns]
     2   pct_chg     float64       
     3   circ_mv     float64       
     4   BM          float64       
    dtypes: datetime64[ns](1), float64(3), object(1)
    memory usage: 84.7+ MB



```python
import statsmodels.api as sm
import numpy as np
import pandas as pd
from scipy.stats.mstats import winsorize
from sklearn.preprocessing import StandardScaler

def get_OLS_resid(X, y):
    X = sm.add_constant(X)
    mod = sm.OLS(y, X)
    res = mod.fit()
    return res.resid


# 中位数去极值
def mad(series,n=3):
    median = series.quantile(0.5)
    diff_median = ((series - median).abs()).quantile(0.5)
    max_range = median + n * diff_median
    min_range = median - n * diff_median
    return np.clip(series, min_range, max_range)

# 3 sigma
def three_sigma(series,n=3):
    mean = series.mean()
    std = series.std()
    max_range = mean + n * std
    min_range = mean - n * std
    return np.clip(series, min_range, max_range)


def neutralize(data, y_col='variable_step1'):
    X_col = ['ln_mv', 'industry']
    X = pd.get_dummies(data, drop_first=True)
    y = data[y_col]
    resid = get_OLS_resid(X, y)
    return resid

def get_final_return(data, q5='high', q1='low', group='group_lag1', return_type='equal'):
    # 分组
    group_5 = data[data[group] == q5]
    group_1 = data[data[group] == q1]
    
    if return_type == 'weighted':
        # 流通市值加权
        group_5_return = (group_5['pct_chg'] * group_5['circ_mv']).sum() / group_5['circ_mv'].sum()
        group_1_return = (group_1['pct_chg'] * group_1['circ_mv']).sum() / group_1['circ_mv'].sum()

    elif return_type == 'equal':
        # 等权重
        group_5_return = group_5['pct_chg'].mean()
        group_1_return = group_1['pct_chg'].mean()
    
    return group_5_return - group_1_return
```


```python
import numpy as np
import pandas as pd
from scipy.stats.mstats import winsorize
from sklearn.preprocessing import StandardScaler
from functools import partial


# 疑问：异常值处理需要每一期处理一次吗？
# data需要有的变量为:ts_code, trade_date, pct_chg, circ_mv, industry
# return_type=''

def get_long_short_return(data, target_variable, outliers_deal='winsorize', n=3, q=5, zuhe='long-short', return_type='equal'):
    # 排序及索引处理
    data = data.sort_values(['ts_code', 'trade_date']).copy()
    data = data.reset_index().drop('index', axis=1)
    
    if data.trade_date.dtype != 'datetime64[ns]':
        data['trade_date'] = pd.to_datetime(data['trade_date'])
    
    # 去极值
    if outliers_deal == 'mad':
        data['variable_step1'] = mad(data[target_variable], n=3)
    elif outliers_deal == 'three_sigma':
        data['variable_step1'] = three_sigma(data[target_variable], n=3)
    elif outliers_deal == 'winsorize':
        # data['variable_step1'] = winsorize(data[target_variable], limits=[0.01,0.01])
        winsor = partial(winsorize, limits=[0.01,0.01])
        data['variable_step1'] = data.groupby('trade_date')[target_variable].apply(winsor)
    else:
        print("没有去极值处理！")
        data['variable_step1'] = data[target_variable]
    
    # 行业市值对数中性化
    if 'industry' in data.columns:
        data['ln_mv'] = np.log(data['circ_mv'])
        data['variable_step2'] = data.groupby('trade_date').apply(neutralize, axis=1)
    else: 
        print("没有行业市值对数中性化！")
        data['variable_step2'] = data['variable_step1']
        
    # 标准化处理
    data['variable_step3'] = data.groupby('trade_date')['variable_step2'].apply(lambda x: (x - np.mean(x)) / (np.std(x)))
    
    # 分组
    labels = ['low', *[i for i in range(2, q)] , 'high']
    qcut_func = partial(pd.qcut, q=q, labels=labels)
    
    data['group'] = data.groupby('trade_date')['variable_step3'].apply(qcut_func)
    data['group_lag1'] = data.groupby('ts_code')['group'].shift(1)
    print(data['group'].unique())
    
    if zuhe == 'long-short':
        q5, q1 = ['high', 'low']
    elif zuhe == 'short-long':
        q1, q5 = ['high', 'low']
    
    get_final_return_func = partial(get_final_return, group='group_lag1', q5=q5, q1=q1, return_type=return_type)
    # 计算每日组合的差异收益率
    return data, data.groupby("trade_date").apply(get_final_return_func).reset_index()
```


```python
_, a = get_long_short_return(df_BM, target_variable='BM', outliers_deal='')
```

    没有去极值处理！
    没有行业市值对数中性化！
    [4, 'high', 3, 'low', 2]
    Categories (5, object): ['low' < 2 < 3 < 4 < 'high']



```python
_
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_code</th>
      <th>trade_date</th>
      <th>pct_chg</th>
      <th>circ_mv</th>
      <th>BM</th>
      <th>variable_step1</th>
      <th>variable_step2</th>
      <th>variable_step3</th>
      <th>group</th>
      <th>group_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000001.SZ</td>
      <td>2010-01-29</td>
      <td>-0.1096</td>
      <td>6.345328e+06</td>
      <td>0.283262</td>
      <td>0.283262</td>
      <td>0.283262</td>
      <td>0.286887</td>
      <td>4</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000001.SZ</td>
      <td>2010-02-26</td>
      <td>0.0346</td>
      <td>6.564637e+06</td>
      <td>0.273800</td>
      <td>0.273800</td>
      <td>0.273800</td>
      <td>0.324584</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000001.SZ</td>
      <td>2010-03-31</td>
      <td>0.0334</td>
      <td>6.783945e+06</td>
      <td>0.284115</td>
      <td>0.284115</td>
      <td>0.284115</td>
      <td>0.457327</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000001.SZ</td>
      <td>2010-04-30</td>
      <td>-0.1138</td>
      <td>6.011979e+06</td>
      <td>0.346284</td>
      <td>0.346284</td>
      <td>0.346284</td>
      <td>0.629283</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000001.SZ</td>
      <td>2010-05-31</td>
      <td>-0.1483</td>
      <td>5.120124e+06</td>
      <td>0.406603</td>
      <td>0.406603</td>
      <td>0.406603</td>
      <td>0.753647</td>
      <td>high</td>
      <td>4</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>207149</th>
      <td>603999.SH</td>
      <td>2017-02-28</td>
      <td>0.0915</td>
      <td>3.461760e+05</td>
      <td>0.187375</td>
      <td>0.187375</td>
      <td>0.187375</td>
      <td>-0.551248</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>207150</th>
      <td>603999.SH</td>
      <td>2017-03-31</td>
      <td>-0.1101</td>
      <td>3.080448e+05</td>
      <td>0.210571</td>
      <td>0.210571</td>
      <td>0.210571</td>
      <td>-0.447549</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>207151</th>
      <td>603999.SH</td>
      <td>2017-04-28</td>
      <td>-0.1163</td>
      <td>2.722176e+05</td>
      <td>0.241511</td>
      <td>0.241511</td>
      <td>0.241511</td>
      <td>-0.379421</td>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>207152</th>
      <td>603999.SH</td>
      <td>2017-05-31</td>
      <td>-0.1710</td>
      <td>2.256768e+05</td>
      <td>0.293850</td>
      <td>0.293850</td>
      <td>0.293850</td>
      <td>-0.223205</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>207153</th>
      <td>603999.SH</td>
      <td>2017-06-30</td>
      <td>0.1394</td>
      <td>2.571264e+05</td>
      <td>0.257905</td>
      <td>0.257905</td>
      <td>0.257905</td>
      <td>-0.335785</td>
      <td>3</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>207154 rows × 10 columns</p>
</div>




```python
(a.set_index("trade_date")+1).cumprod().plot(figsize=(9, 5))
```




    <matplotlib.axes._subplots.AxesSubplot at 0x221594ca700>




![png](%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_files/%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_18_1.png)



```python
_.groupby('group')['pct_chg'].describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>group</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>low</th>
      <td>41469.0</td>
      <td>0.053636</td>
      <td>0.365317</td>
      <td>-0.8354</td>
      <td>-0.0756</td>
      <td>0.0150</td>
      <td>0.115400</td>
      <td>9.6580</td>
    </tr>
    <tr>
      <th>2</th>
      <td>41410.0</td>
      <td>0.026062</td>
      <td>0.242654</td>
      <td>-0.7973</td>
      <td>-0.0770</td>
      <td>0.0074</td>
      <td>0.097100</td>
      <td>6.2867</td>
    </tr>
    <tr>
      <th>3</th>
      <td>41418.0</td>
      <td>0.010376</td>
      <td>0.185973</td>
      <td>-0.8226</td>
      <td>-0.0775</td>
      <td>0.0014</td>
      <td>0.084275</td>
      <td>3.5292</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41405.0</td>
      <td>-0.000567</td>
      <td>0.148411</td>
      <td>-0.8014</td>
      <td>-0.0754</td>
      <td>-0.0028</td>
      <td>0.071000</td>
      <td>2.7390</td>
    </tr>
    <tr>
      <th>high</th>
      <td>41452.0</td>
      <td>-0.006907</td>
      <td>0.120373</td>
      <td>-0.7645</td>
      <td>-0.0679</td>
      <td>-0.0063</td>
      <td>0.054300</td>
      <td>1.6587</td>
    </tr>
  </tbody>
</table>
</div>




```python
_.groupby('group')['pct_chg'].mean().plot.bar()
```




    <matplotlib.axes._subplots.AxesSubplot at 0x2213c1af100>




![png](%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_files/%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_20_1.png)



```python
_.groupby('group_lag1')['pct_chg'].mean().plot.bar()
```




    <matplotlib.axes._subplots.AxesSubplot at 0x22155c26bb0>




![png](%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_files/%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_21_1.png)



```python
# df_BM.groupby('trade_date')["BM"].apply(lambda x: pd.qcut(x, q=5))
```

# 月度行情


```python
df = pro.index_monthly(ts_code='000001.SH', start_date='20100101', end_date='20210501')
```


```python
dates = list(df.sort_values('trade_date')['trade_date'].values)
```


```python
df_final = pd.DataFrame()

for d in dates:
    _ = pro.monthly(trade_date=d)
    df_basic = get_basic(trade_date=d)
    _ = pd.merge(_, df_basic, on='ts_code', how='left')
    print(f"{d} done!")
    df_final = df_final.append(_)
```



```python
df_final['BM'] = 1 / df_final['pb']
```


```python
df_BM = df_final[['ts_code', 'trade_date_x', 'pct_chg', 'circ_mv', 'BM']]
```


```python
df_BM.columns = ['ts_code', 'trade_date', 'pct_chg', 'circ_mv', 'BM']
```


```python
df_BM.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 215057 entries, 0 to 3084
    Data columns (total 5 columns):
     #   Column      Non-Null Count   Dtype  
    ---  ------      --------------   -----  
     0   ts_code     215057 non-null  object 
     1   trade_date  215057 non-null  object 
     2   pct_chg     215057 non-null  float64
     3   circ_mv     208807 non-null  float64
     4   BM          207154 non-null  float64
    dtypes: float64(3), object(2)
    memory usage: 9.8+ MB



```python
df_BM = df_BM.dropna()
```


```python
_, a = get_long_short_return(df_BM, target_variable='BM', outliers_deal='')
```

    没有去极值处理！
    没有行业市值对数中性化！
    [4, 'high', 3, 'low', 2]
    Categories (5, object): ['low' < 2 < 3 < 4 < 'high']


    <ipython-input-174-17dfd8511da5>:45: RuntimeWarning: invalid value encountered in double_scalars
      group_5_return = (group_5['pct_chg'] * group_5['circ_mv']).sum() / group_5['circ_mv'].sum()
    <ipython-input-174-17dfd8511da5>:46: RuntimeWarning: invalid value encountered in double_scalars
      group_1_return = (group_1['pct_chg'] * group_1['circ_mv']).sum() / group_1['circ_mv'].sum()



```python
(a.set_index("trade_date")+1).cumprod().plot()
```




    <matplotlib.axes._subplots.AxesSubplot at 0x2215219af70>




![png](%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_files/%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_33_1.png)



```python
_.groupby('group')['pct_chg'].mean().plot.bar()
```




    <matplotlib.axes._subplots.AxesSubplot at 0x22155bd8af0>




![png](%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_files/%E5%9B%A0%E5%AD%90%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95_34_1.png)



```python
_.groupby("trade_date")['group'].value_counts().sort_index()
```




    trade_date  group
    2010-01-29  low      326
                2        326
                3        325
                4        326
                high     326
                        ... 
    2017-06-30  low      603
                2        602
                3        603
                4        602
                high     603
    Name: group, Length: 450, dtype: int64




```python
_['gg'] = pd.qcut(_['BM'], q=10, labels=range(1, 11))
```


```python
_.groupby('gg')[['BM', 'pct_chg']].mean()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BM</th>
      <th>pct_chg</th>
    </tr>
    <tr>
      <th>gg</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.078443</td>
      <td>0.090771</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.141785</td>
      <td>0.049689</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.185886</td>
      <td>0.030886</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.228082</td>
      <td>0.019598</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.272256</td>
      <td>0.011296</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.321875</td>
      <td>0.002436</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.380851</td>
      <td>-0.003861</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.455817</td>
      <td>-0.007698</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.566074</td>
      <td>-0.011766</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.857355</td>
      <td>-0.016100</td>
    </tr>
  </tbody>
</table>
</div>




```python
_
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_code</th>
      <th>trade_date</th>
      <th>pct_chg</th>
      <th>circ_mv</th>
      <th>BM</th>
      <th>variable_step1</th>
      <th>variable_step2</th>
      <th>variable_step3</th>
      <th>group</th>
      <th>group_lag1</th>
      <th>gg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000001.SZ</td>
      <td>2010-01-29</td>
      <td>-0.1096</td>
      <td>6.345328e+06</td>
      <td>0.283262</td>
      <td>0.283262</td>
      <td>0.283262</td>
      <td>0.286887</td>
      <td>4</td>
      <td>NaN</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000001.SZ</td>
      <td>2010-02-26</td>
      <td>0.0346</td>
      <td>6.564637e+06</td>
      <td>0.273800</td>
      <td>0.273800</td>
      <td>0.273800</td>
      <td>0.324584</td>
      <td>4</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000001.SZ</td>
      <td>2010-03-31</td>
      <td>0.0334</td>
      <td>6.783945e+06</td>
      <td>0.284115</td>
      <td>0.284115</td>
      <td>0.284115</td>
      <td>0.457327</td>
      <td>4</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000001.SZ</td>
      <td>2010-04-30</td>
      <td>-0.1138</td>
      <td>6.011979e+06</td>
      <td>0.346284</td>
      <td>0.346284</td>
      <td>0.346284</td>
      <td>0.629283</td>
      <td>4</td>
      <td>4</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000001.SZ</td>
      <td>2010-05-31</td>
      <td>-0.1483</td>
      <td>5.120124e+06</td>
      <td>0.406603</td>
      <td>0.406603</td>
      <td>0.406603</td>
      <td>0.753647</td>
      <td>high</td>
      <td>4</td>
      <td>7</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>207149</th>
      <td>603999.SH</td>
      <td>2017-02-28</td>
      <td>0.0915</td>
      <td>3.461760e+05</td>
      <td>0.187375</td>
      <td>0.187375</td>
      <td>0.187375</td>
      <td>-0.551248</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>207150</th>
      <td>603999.SH</td>
      <td>2017-03-31</td>
      <td>-0.1101</td>
      <td>3.080448e+05</td>
      <td>0.210571</td>
      <td>0.210571</td>
      <td>0.210571</td>
      <td>-0.447549</td>
      <td>2</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <th>207151</th>
      <td>603999.SH</td>
      <td>2017-04-28</td>
      <td>-0.1163</td>
      <td>2.722176e+05</td>
      <td>0.241511</td>
      <td>0.241511</td>
      <td>0.241511</td>
      <td>-0.379421</td>
      <td>3</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <th>207152</th>
      <td>603999.SH</td>
      <td>2017-05-31</td>
      <td>-0.1710</td>
      <td>2.256768e+05</td>
      <td>0.293850</td>
      <td>0.293850</td>
      <td>0.293850</td>
      <td>-0.223205</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>207153</th>
      <td>603999.SH</td>
      <td>2017-06-30</td>
      <td>0.1394</td>
      <td>2.571264e+05</td>
      <td>0.257905</td>
      <td>0.257905</td>
      <td>0.257905</td>
      <td>-0.335785</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
<p>207154 rows × 11 columns</p>
</div>




```python
df_final
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_code</th>
      <th>trade_date_x</th>
      <th>close_x</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>pre_close</th>
      <th>change</th>
      <th>pct_chg</th>
      <th>vol</th>
      <th>...</th>
      <th>ps</th>
      <th>ps_ttm</th>
      <th>dv_ratio</th>
      <th>dv_ttm</th>
      <th>total_share</th>
      <th>float_share</th>
      <th>free_share</th>
      <th>total_mv</th>
      <th>circ_mv</th>
      <th>BM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000001.SZ</td>
      <td>20100129</td>
      <td>21.70</td>
      <td>24.52</td>
      <td>24.58</td>
      <td>20.60</td>
      <td>24.37</td>
      <td>-2.67</td>
      <td>-0.1096</td>
      <td>9.495587e+08</td>
      <td>...</td>
      <td>4.6432</td>
      <td>4.5270</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.105434e+05</td>
      <td>2.924114e+05</td>
      <td>258459.8097</td>
      <td>6.738791e+06</td>
      <td>6.345328e+06</td>
      <td>0.283262</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000002.SZ</td>
      <td>20100129</td>
      <td>9.34</td>
      <td>10.85</td>
      <td>10.87</td>
      <td>9.18</td>
      <td>10.81</td>
      <td>-1.47</td>
      <td>-0.1360</td>
      <td>2.438424e+09</td>
      <td>...</td>
      <td>2.5053</td>
      <td>2.1398</td>
      <td>0.5353</td>
      <td>0.5353</td>
      <td>1.099521e+06</td>
      <td>9.656095e+05</td>
      <td>803700.0144</td>
      <td>1.026953e+07</td>
      <td>9.018793e+06</td>
      <td>0.340252</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000005.SZ</td>
      <td>20100129</td>
      <td>5.39</td>
      <td>6.01</td>
      <td>6.32</td>
      <td>5.03</td>
      <td>6.02</td>
      <td>-0.63</td>
      <td>-0.1047</td>
      <td>5.769023e+08</td>
      <td>...</td>
      <td>45.3297</td>
      <td>87.5187</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.143336e+04</td>
      <td>9.137430e+04</td>
      <td>72950.2562</td>
      <td>4.928258e+05</td>
      <td>4.925075e+05</td>
      <td>0.150202</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000006.SZ</td>
      <td>20100129</td>
      <td>9.96</td>
      <td>11.33</td>
      <td>11.35</td>
      <td>9.75</td>
      <td>11.33</td>
      <td>-1.37</td>
      <td>-0.1209</td>
      <td>2.172662e+08</td>
      <td>...</td>
      <td>4.9440</td>
      <td>2.7481</td>
      <td>0.8000</td>
      <td>0.8000</td>
      <td>5.071833e+04</td>
      <td>4.920297e+04</td>
      <td>39687.6489</td>
      <td>5.051545e+05</td>
      <td>4.900615e+05</td>
      <td>0.417571</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000007.SZ</td>
      <td>20100129</td>
      <td>6.91</td>
      <td>7.09</td>
      <td>7.75</td>
      <td>6.70</td>
      <td>7.03</td>
      <td>-0.12</td>
      <td>-0.0171</td>
      <td>6.331272e+07</td>
      <td>...</td>
      <td>8.0389</td>
      <td>9.3423</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.849654e+04</td>
      <td>1.849654e+04</td>
      <td>14475.9137</td>
      <td>1.278111e+05</td>
      <td>1.278111e+05</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3080</th>
      <td>603993.SH</td>
      <td>20170630</td>
      <td>5.06</td>
      <td>4.20</td>
      <td>5.11</td>
      <td>3.96</td>
      <td>4.21</td>
      <td>0.85</td>
      <td>0.2019</td>
      <td>2.908382e+09</td>
      <td>...</td>
      <td>12.2956</td>
      <td>7.3824</td>
      <td>0.4941</td>
      <td>1.1858</td>
      <td>1.688720e+06</td>
      <td>1.295373e+06</td>
      <td>259373.0274</td>
      <td>8.544923e+06</td>
      <td>6.554588e+06</td>
      <td>0.212373</td>
    </tr>
    <tr>
      <th>3081</th>
      <td>603996.SH</td>
      <td>20170630</td>
      <td>17.10</td>
      <td>16.81</td>
      <td>17.67</td>
      <td>15.63</td>
      <td>17.04</td>
      <td>0.06</td>
      <td>0.0035</td>
      <td>3.837413e+07</td>
      <td>...</td>
      <td>1.2254</td>
      <td>1.2018</td>
      <td>1.5595</td>
      <td>0.8772</td>
      <td>3.001500e+04</td>
      <td>1.032750e+04</td>
      <td>10327.5000</td>
      <td>5.132565e+05</td>
      <td>1.766002e+05</td>
      <td>0.263498</td>
    </tr>
    <tr>
      <th>3082</th>
      <td>603997.SH</td>
      <td>20170630</td>
      <td>14.61</td>
      <td>15.80</td>
      <td>15.85</td>
      <td>14.00</td>
      <td>14.36</td>
      <td>0.25</td>
      <td>0.0174</td>
      <td>1.465439e+08</td>
      <td>...</td>
      <td>6.2806</td>
      <td>5.8554</td>
      <td>0.5932</td>
      <td>1.6883</td>
      <td>6.300000e+04</td>
      <td>1.710000e+04</td>
      <td>17100.0000</td>
      <td>9.204300e+05</td>
      <td>2.498310e+05</td>
      <td>0.163212</td>
    </tr>
    <tr>
      <th>3083</th>
      <td>603998.SH</td>
      <td>20170630</td>
      <td>13.86</td>
      <td>13.38</td>
      <td>14.68</td>
      <td>12.97</td>
      <td>13.29</td>
      <td>0.57</td>
      <td>0.0429</td>
      <td>4.084229e+07</td>
      <td>...</td>
      <td>11.2333</td>
      <td>10.5805</td>
      <td>0.4723</td>
      <td>NaN</td>
      <td>4.330067e+04</td>
      <td>2.691772e+04</td>
      <td>22213.8220</td>
      <td>6.001473e+05</td>
      <td>3.730796e+05</td>
      <td>0.157672</td>
    </tr>
    <tr>
      <th>3084</th>
      <td>603999.SH</td>
      <td>20170630</td>
      <td>22.32</td>
      <td>19.54</td>
      <td>22.99</td>
      <td>18.18</td>
      <td>19.59</td>
      <td>2.73</td>
      <td>0.1394</td>
      <td>7.499747e+07</td>
      <td>...</td>
      <td>8.5609</td>
      <td>8.5904</td>
      <td>0.4854</td>
      <td>NaN</td>
      <td>2.880000e+04</td>
      <td>1.152000e+04</td>
      <td>9958.3783</td>
      <td>6.428160e+05</td>
      <td>2.571264e+05</td>
      <td>0.257905</td>
    </tr>
  </tbody>
</table>
<p>215057 rows × 29 columns</p>
</div>




```python
_
```




    ''

