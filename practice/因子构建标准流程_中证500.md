# 1. 导入库和数据


```python
import pandas as pd
import numpy as np
import os
from tqdm import tqdm

import warnings
warnings.filterwarnings('ignore')
```


```python
os.chdir(r"E:\因子投资\周频数据")

weekly_list = os.listdir()
weekly_list = sorted(weekly_list)
target_list = [i for i in weekly_list if int(i[:-4]) > 20100101]
```


```python
weekly_df = pd.concat(map(pd.read_csv, tqdm(target_list)), axis=0)
```

    100%|████████████████████████████████████████████████████████████████████████████████| 607/607 [00:06<00:00, 98.05it/s]
    

# 2. 确定股票池


```python
# 构建股票池

import tushare as ts
token = 'c8811a29e9b51d03b2b3f6be3937f331d6187999563900664056c438'
ts.set_token(token)
pro = ts.pro_api()
stock_list = list(pro.index_weight(index_code='000905.SH', start_date='20211001', end_date='20211101').con_code.unique())
print("股票池: ", len(stock_list))

weekly_df = weekly_df[weekly_df.ts_code.isin(stock_list)]
print("weekly_df: ", weekly_df.shape)
```

    股票池:  500
    weekly_df:  (247221, 11)
    

# 3. 数据对标


```python
weekly_df['trade_date'] = pd.to_datetime(weekly_df['trade_date'], format='%Y%m%d')
```


```python
# 财务指标对标专用
def indicator_duibiao(date):
    date = str(date)
    y, m, d = date.split("-")
    if m in ['01', '02', '03', '04']:
        return str(int(y)-1) + '-09-30'
    elif m in ['05', '06', '07', '08']:
        return y + '-03-31'
    elif m in ['09', '10']:
        return y + '-06-30'
    elif m in ['11', '12']:
        return y + '-09-30'
    else:
        print("出现异常!")
```


```python
weekly_df['duibiao'] = weekly_df['trade_date'].apply(indicator_duibiao)
```


```python
weekly_df = weekly_df.sort_values(['ts_code', 'trade_date'])
```


```python
weekly_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_code</th>
      <th>trade_date</th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>pre_close</th>
      <th>change</th>
      <th>pct_chg</th>
      <th>vol</th>
      <th>amount</th>
      <th>duibiao</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>000009.SZ</td>
      <td>2010-01-08</td>
      <td>11.27</td>
      <td>11.00</td>
      <td>11.32</td>
      <td>10.28</td>
      <td>10.98</td>
      <td>0.29</td>
      <td>0.0264</td>
      <td>174897664.0</td>
      <td>1.885129e+09</td>
      <td>2009-09-30</td>
    </tr>
    <tr>
      <th>5</th>
      <td>000009.SZ</td>
      <td>2010-01-15</td>
      <td>11.44</td>
      <td>11.36</td>
      <td>11.55</td>
      <td>10.50</td>
      <td>11.27</td>
      <td>0.17</td>
      <td>0.0151</td>
      <td>185491540.0</td>
      <td>2.060969e+09</td>
      <td>2009-09-30</td>
    </tr>
    <tr>
      <th>6</th>
      <td>000009.SZ</td>
      <td>2010-01-22</td>
      <td>11.28</td>
      <td>11.43</td>
      <td>12.33</td>
      <td>11.03</td>
      <td>11.44</td>
      <td>-0.16</td>
      <td>-0.0140</td>
      <td>193091846.0</td>
      <td>2.279873e+09</td>
      <td>2009-09-30</td>
    </tr>
    <tr>
      <th>6</th>
      <td>000009.SZ</td>
      <td>2010-01-29</td>
      <td>10.43</td>
      <td>11.26</td>
      <td>11.26</td>
      <td>9.97</td>
      <td>11.28</td>
      <td>-0.85</td>
      <td>-0.0754</td>
      <td>86600704.0</td>
      <td>9.097580e+08</td>
      <td>2009-09-30</td>
    </tr>
    <tr>
      <th>6</th>
      <td>000009.SZ</td>
      <td>2010-02-05</td>
      <td>11.18</td>
      <td>10.38</td>
      <td>12.10</td>
      <td>9.98</td>
      <td>10.43</td>
      <td>0.75</td>
      <td>0.0719</td>
      <td>277911026.0</td>
      <td>3.152861e+09</td>
      <td>2009-09-30</td>
    </tr>
  </tbody>
</table>
</div>




```python
# ************日频对标***************
weekly_df['duibiao2'] = weekly_df.groupby('ts_code')['trade_date'].shift(1)
```


```python
weekly_df.isnull().sum()
```




    ts_code         0
    trade_date      0
    close           0
    open            0
    high            0
    low             0
    pre_close       0
    change          0
    pct_chg         0
    vol             0
    amount          0
    duibiao         0
    duibiao2      500
    dtype: int64




```python
weekly_df_02 = weekly_df.dropna()
```


```python
bmmv = pd.read_csv(r"E:\因子投资\因子库\BM_MV因子.csv")
fazhan = pd.read_csv(r"E:\因子投资\因子库\csmar发展能力因子.csv", dtype={"Stkcd": "object"})
hkhold = pd.read_csv(r"E:\因子投资\因子库\Hkhold因子.csv")
```


```python
bmmv = bmmv.rename(columns={"trade_date": "duibiao2"})
hkhold = hkhold.rename(columns={"trade_date": "duibiao2"})
fazhan = fazhan.rename(columns={"Accper": "duibiao"})
```


```python
bmmv['duibiao2'] = pd.to_datetime(bmmv['duibiao2'], format='%Y%m%d')
hkhold['duibiao2'] = pd.to_datetime(hkhold['duibiao2'], format='%Y%m%d')
fazhan['duibiao'] = pd.to_datetime(fazhan['duibiao'])
```


```python
weekly_df_02.shape
```




    (246721, 13)




```python
weekly_df_02['Stkcd'] = weekly_df_02['ts_code'].str[:-3]
```


```python
weekly_df_02['duibiao'] = pd.to_datetime(weekly_df_02['duibiao'])
```

# 4. 因子数据与行情数据合并


```python
df_concat_01 = weekly_df_02.merge(bmmv, on=['ts_code', 'duibiao2'], how='left') \
    .merge(hkhold, on=['ts_code', 'duibiao2'], how='left') \
    .merge(fazhan, on=['Stkcd', 'duibiao'], how='left')
```


```python
df_concat_01.columns
```




    Index(['ts_code', 'trade_date', 'close', 'open', 'high', 'low', 'pre_close',
           'change', 'pct_chg', 'vol', 'amount', 'duibiao', 'duibiao2', 'Stkcd',
           'BM', 'mv', 'Hkhold', 'F080601A', 'F080602A', 'F081601B', 'F081602C',
           'F082601B', 'F081003B', 'F081603B', 'F080603A', 'F082602B', 'F082603B'],
          dtype='object')




```python
X_cols = ['BM', 'mv', 'Hkhold', 'F080601A', 'F080602A', 'F081601B', 'F081602C',
       'F082601B', 'F081003B', 'F081603B', 'F080603A', 'F082602B', 'F082603B']
```


```python
df_concat_01.shape
```




    (246721, 27)




```python
df_concat_01[X_cols].isnull().sum()
```




    BM            2368
    mv            1964
    Hkhold      138017
    F080601A      2623
    F080602A     12949
    F081601B      7663
    F081602C     13151
    F082601B      2481
    F081003B     12949
    F081603B     13151
    F080603A     12949
    F082602B      2825
    F082603B     22295
    dtype: int64



## 4.1 向后填充缺失值（可选）


```python
for col in X_cols:
    df_concat_01[col] = df_concat_01.groupby("ts_code")[col].fillna(method='ffill')
```


```python
df_concat_01[X_cols].isnull().sum()
```




    BM             426
    mv               6
    Hkhold      134860
    F080601A      2580
    F080602A     12949
    F081601B      7287
    F081602C     13018
    F082601B      2481
    F081003B     12949
    F081603B     13018
    F080603A     12949
    F082602B      2825
    F082603B      4565
    dtype: int64



# 5. 取极值化


```python
# from scipy.stats.mstats import winsorize
from sklearn.preprocessing import StandardScaler

def winsorize_series(s):
    q = s.quantile([0.05, 0.95])
    if isinstance(q, pd.Series) and len(q) == 2:
        s[s < q.iloc[0]] = q.iloc[0]
        s[s > q.iloc[1]] = q.iloc[1]
    return s
```


```python
df_concat_01.index = range(df_concat_01.shape[0])
```


```python
# 非常好用的transform
for Value in X_cols:
    df_concat_01[f"{Value}_winsorized"] = df_concat_01.groupby('trade_date')[Value].apply(winsorize_series)
```


```python
X_cols_wins = [f"{i}_winsorized" for i in X_cols]
```


```python
df_concat_01[X_cols_wins].isnull().sum()
```




    BM_winsorized             426
    mv_winsorized               6
    Hkhold_winsorized      134860
    F080601A_winsorized      2580
    F080602A_winsorized     12949
    F081601B_winsorized      7287
    F081602C_winsorized     13018
    F082601B_winsorized      2481
    F081003B_winsorized     12949
    F081603B_winsorized     13018
    F080603A_winsorized     12949
    F082602B_winsorized      2825
    F082603B_winsorized      4565
    dtype: int64




```python
df_concat_01[(df_concat_01['F082603B_winsorized'].notnull()) & df_concat_01['F082603B'].isnull()]\
    [['ts_code', 'trade_date', 'F082603B', 'F082603B_winsorized']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_code</th>
      <th>trade_date</th>
      <th>F082603B</th>
      <th>F082603B_winsorized</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>



# 6. 标准化


```python
for col in tqdm(X_cols_wins):
    df_concat_01[f'{col}_scaler'] = df_concat_01.groupby('trade_date')[col].apply(lambda x: (x - np.mean(x)) / (np.std(x)))
```

    100%|██████████████████████████████████████████████████████████████████████████████████| 13/13 [00:05<00:00,  2.45it/s]
    


```python
X_cols_wins
```




    ['BM_winsorized',
     'mv_winsorized',
     'Hkhold_winsorized',
     'F080601A_winsorized',
     'F080602A_winsorized',
     'F081601B_winsorized',
     'F081602C_winsorized',
     'F082601B_winsorized',
     'F081003B_winsorized',
     'F081603B_winsorized',
     'F080603A_winsorized',
     'F082602B_winsorized',
     'F082603B_winsorized']




```python
# df_concat_01.groupby('trade_date')['BM_winsorized_scaler'].apply(lambda x: pd.qcut(x, q=10, labels=range(1, 11)))
```

# 7. 指标分箱


```python
def qcut(s):
    try:
        return pd.qcut(s, q=10, labels=range(1, 11))
    except:
        return pd.Series([np.nan] * s.shape[0], index=s.index)
```


```python
X_cols_scaler = [f"{i}_scaler" for i in X_cols_wins]
```


```python
for col in tqdm(X_cols_scaler):
    df_concat_01[f"group_{col}"] = df_concat_01.groupby('trade_date')[col].apply(qcut)
```

    100%|██████████████████████████████████████████████████████████████████████████████████| 13/13 [00:11<00:00,  1.09it/s]
    


```python
group_cols = [f"group_{i}" for i in X_cols_scaler]
```

# 8. 构建多空组合并画图


```python
# 加入高效函数****************************************************************************
import matplotlib.pyplot as plt
# 中文乱码
plt.rcParams['font.sans-serif']=['SimHei'] #用来正常显示中文标签
plt.rcParams['axes.unicode_minus']=False #用来正常显示负号


def long_short_plot(data, group_var, date_val='trade_date', return_var='pct_chg', long_short=True):
    # 分组统计

    plt.figure()
    data.groupby(group_var)[return_var].mean().plot.bar()
    plt.title(f"{group_var}分组平均收益率")

    plt.figure()
    _ = data.groupby([group_var, date_val])[return_var].mean()
    new = _.unstack().T

    (new+1).cumprod().plot(figsize=(10, 6), colormap='Blues')

    if long_short:
        ((new[10] - new[1]) + 1).cumprod().plot(color='red')
    plt.title(f"{group_var}分组累计收益率")

    return (new[10]+1).cumprod()
```


```python
for i in group_cols:
    _ = long_short_plot(df_concat_01, group_var=i, date_val='trade_date', return_var='pct_chg')
```


![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_0.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_2.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_3.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_5.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_6.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_8.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_9.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_11.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_12.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_14.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_15.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_17.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_18.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_20.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_21.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_23.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_24.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_26.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_27.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_29.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_30.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_32.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_33.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_35.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_36.png)



    <Figure size 432x288 with 0 Axes>



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_48_38.png)



```python
X_cols_scaler
```




    ['BM_winsorized_scaler',
     'mv_winsorized_scaler',
     'Hkhold_winsorized_scaler',
     'F080601A_winsorized_scaler',
     'F080602A_winsorized_scaler',
     'F081601B_winsorized_scaler',
     'F081602C_winsorized_scaler',
     'F082601B_winsorized_scaler',
     'F081003B_winsorized_scaler',
     'F081603B_winsorized_scaler',
     'F080603A_winsorized_scaler',
     'F082602B_winsorized_scaler',
     'F082603B_winsorized_scaler']



# 10. 计算IC值


```python
def ic_value(data, var, return_val='pct_chg', date='trade_date'):
    ic_df = data.groupby(date).apply(lambda x: x[[return_val, var]].corr().iloc[0, 1])
    print(f"{var} IC 值为: {ic_df.mean()}, 标准差为: {ic_df.std()}")
    plt.figure()
    ic_df.plot()
    plt.axhline(ic_df.mean(), color='red')
```


```python
# _ = df_concat_01.groupby("trade_date").apply(lambda x: x[['pct_chg', 'BM_winsorized_scaler']].corr().iloc[0, 1])
```


```python
for c in X_cols_scaler:
    ic_value(df_concat_01, var=c)
```

    BM_winsorized_scaler IC 值为: -0.0027314668177015797, 标准差为: 0.1553590838947405
    mv_winsorized_scaler IC 值为: -0.04713464495202468, 标准差为: 0.12161070705355319
    Hkhold_winsorized_scaler IC 值为: 0.009109203462610727, 标准差为: 0.09845315540173033
    F080601A_winsorized_scaler IC 值为: -0.005029133898151264, 标准差为: 0.07515894251910367
    F080602A_winsorized_scaler IC 值为: -0.00768690840683571, 标准差为: 0.0844347418594041
    F081601B_winsorized_scaler IC 值为: 0.00868574761874097, 标准差为: 0.06428637155387686
    F081602C_winsorized_scaler IC 值为: 0.005947921257117017, 标准差为: 0.08535743486406676
    F082601B_winsorized_scaler IC 值为: 0.00010109756925615609, 标准差为: 0.10883074954830772
    F081003B_winsorized_scaler IC 值为: 0.008281483844250587, 标准差为: 0.08675954338942236
    F081603B_winsorized_scaler IC 值为: 0.005947921257117017, 标准差为: 0.08535743486406676
    F080603A_winsorized_scaler IC 值为: -0.00768690840683571, 标准差为: 0.0844347418594041
    F082602B_winsorized_scaler IC 值为: 3.305382767375532e-05, 标准差为: 0.10865882300325674
    F082603B_winsorized_scaler IC 值为: 0.0007459819700910521, 标准差为: 0.10377723568329271
    


![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_1.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_2.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_3.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_4.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_5.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_6.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_7.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_8.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_9.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_10.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_11.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_12.png)



![png](%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_files/%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B_%E4%B8%AD%E8%AF%81500_53_13.png)

