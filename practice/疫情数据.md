```python
import pandas as pd
import time
import seaborn as sns
import matplotlib.pyplot as plt
import matplotlib as mpl
import datetime
# sns.set()
#正常显示画图时出现的中文和负号
from pylab import mpl
mpl.rcParams['font.sans-serif']=['SimHei']
mpl.rcParams['axes.unicode_minus']=False
#使用tushare获取数据
import tushare as ts
#设置好你的token
token = 'b15148f5ca285bd0e85bbc3f659daefff549ade3bba06fae6a037f03'
pro = ts.pro_api(token)
```


```python
# 优雅撸数据
def get_daily(ts_code='', trade_date='', start_date='', end_date=''):
    try:
        if trade_date:
            df = pro.daily(ts_code=ts_code, trade_date=trade_date)
        else:
            df = pro.daily(ts_code=ts_code, start_date=start_date, end_date=end_date)
    except Exception as e:
        print(e)
        time.sleep(1)
        df = get_daily()
    return df
```


```python
def get_basic(ts_code='', trade_date='', start_date='', end_date=''):
    try:
        if trade_date:
            df = pro.daily_basic(ts_code=ts_code, trade_date=trade_date)
        else:
            df = pro.daily_basic(ts_code=ts_code, start_date=start_date, end_date=end_date)
    except Exception as e:
        print(e)
        time.sleep(1)
        df = get_basic()
    return df
```


```python
start_date='20200110'
end_date='20200309'
```


```python
data = []
df_cal = pro.trade_cal(start_date=start_date, end_date=end_date)
# exchange: 交易所 SSE上交所 SZSE深交所
# is_open: 是否交易 0休市 1交易

df_cal = df_cal.query('(is_open==1)')
```


```python
stock_data = pd.DataFrame()
```


```python
for date in df_cal.cal_date:
    df_daily = get_daily(trade_date=date)
    df_basic = get_basic(trade_date=date)
    df = pd.merge(df_daily, df_basic, on='ts_code', how='inner')
    stock_data = stock_data.append(df)
    df_daily = get_daily(trade_date=date)
```

# 疫情数据获取


```python
import akshare as ak
import numpy as np
```


```python
covid_19_history_df = ak.covid_19_history()
```


```python
covid_19_history_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>country</th>
      <th>countryCode</th>
      <th>province</th>
      <th>provinceCode</th>
      <th>city</th>
      <th>cityCode</th>
      <th>confirmed</th>
      <th>suspected</th>
      <th>cured</th>
      <th>dead</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-12-01</td>
      <td>中国</td>
      <td>CN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-12-01</td>
      <td>中国</td>
      <td>CN</td>
      <td>湖北省</td>
      <td>420000</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-12-01</td>
      <td>中国</td>
      <td>CN</td>
      <td>湖北省</td>
      <td>420000</td>
      <td>武汉市</td>
      <td>420100</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-12-02</td>
      <td>中国</td>
      <td>CN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-12-02</td>
      <td>中国</td>
      <td>CN</td>
      <td>湖北省</td>
      <td>420000</td>
      <td>None</td>
      <td>None</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>229079</th>
      <td>2020-12-08</td>
      <td>马约特</td>
      <td>YT</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>5181</td>
      <td>0</td>
      <td>2964</td>
      <td>49</td>
    </tr>
    <tr>
      <th>229080</th>
      <td>2020-12-08</td>
      <td>南非</td>
      <td>ZA</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>817878</td>
      <td>0</td>
      <td>745750</td>
      <td>22249</td>
    </tr>
    <tr>
      <th>229081</th>
      <td>2020-12-08</td>
      <td>赞比亚</td>
      <td>ZM</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>17931</td>
      <td>0</td>
      <td>17211</td>
      <td>364</td>
    </tr>
    <tr>
      <th>229082</th>
      <td>2020-12-08</td>
      <td>津巴布韦</td>
      <td>ZW</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>10839</td>
      <td>0</td>
      <td>8972</td>
      <td>294</td>
    </tr>
    <tr>
      <th>229083</th>
      <td>2020-12-08</td>
      <td>纳米比亚</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>15219</td>
      <td>0</td>
      <td>13949</td>
      <td>152</td>
    </tr>
  </tbody>
</table>
<p>229084 rows × 11 columns</p>
</div>




```python
covid_19_history_df[covid_19_history_df['country'] == '越南']
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>country</th>
      <th>countryCode</th>
      <th>province</th>
      <th>provinceCode</th>
      <th>city</th>
      <th>cityCode</th>
      <th>confirmed</th>
      <th>suspected</th>
      <th>cured</th>
      <th>dead</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>518</th>
      <td>2020-01-23</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>756</th>
      <td>2020-01-24</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1042</th>
      <td>2020-01-25</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1391</th>
      <td>2020-01-26</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1764</th>
      <td>2020-01-27</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>226058</th>
      <td>2020-12-04</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1361</td>
      <td>0</td>
      <td>1220</td>
      <td>35</td>
    </tr>
    <tr>
      <th>226813</th>
      <td>2020-12-05</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1365</td>
      <td>0</td>
      <td>1220</td>
      <td>35</td>
    </tr>
    <tr>
      <th>227568</th>
      <td>2020-12-06</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1366</td>
      <td>0</td>
      <td>1220</td>
      <td>35</td>
    </tr>
    <tr>
      <th>228322</th>
      <td>2020-12-07</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1367</td>
      <td>0</td>
      <td>1224</td>
      <td>35</td>
    </tr>
    <tr>
      <th>229077</th>
      <td>2020-12-08</td>
      <td>越南</td>
      <td>VN</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>1367</td>
      <td>0</td>
      <td>1224</td>
      <td>35</td>
    </tr>
  </tbody>
</table>
<p>319 rows × 11 columns</p>
</div>




```python
covid_19_history_df = covid_19_history_df[covid_19_history_df['country'] == '中国']
```


```python
covid_19_history_df = covid_19_history_df[~covid_19_history_df['province'].isin(['台湾省', '香港特别行政区', '澳门特别行政区'])]
```


```python
my_data = covid_19_history_df[covid_19_history_df['province'].isin([None])]
```


```python
my_data = my_data[['date', 'confirmed', 'dead']]
my_data.columns = ['date', '累计确诊', '累计死亡']
```


```python
# my_data.to_csv("中国疫情累计数据.csv", encoding='utf_8_sig')
```


```python
my_data['每日确诊'] = my_data['累计确诊'].diff()
my_data['每日死亡'] = my_data['累计死亡'].diff()
```


```python
my_data['每日确诊'] = my_data['每日确诊'].apply(lambda x: 0 if x<0 else x)
my_data['每日死亡'] = my_data['每日死亡'].apply(lambda x: 0 if x<0 else x)
```


```python
my_data = my_data.dropna()
```


```python
my_data
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>累计确诊</th>
      <th>累计死亡</th>
      <th>每日确诊</th>
      <th>每日死亡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>2019-12-02</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2019-12-03</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2019-12-04</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2019-12-05</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2019-12-06</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>225354</th>
      <td>2020-12-04</td>
      <td>94023</td>
      <td>4753</td>
      <td>134.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>226108</th>
      <td>2020-12-05</td>
      <td>94142</td>
      <td>4753</td>
      <td>119.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>226863</th>
      <td>2020-12-06</td>
      <td>94278</td>
      <td>4753</td>
      <td>136.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>227618</th>
      <td>2020-12-07</td>
      <td>94373</td>
      <td>4753</td>
      <td>95.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>228372</th>
      <td>2020-12-08</td>
      <td>94488</td>
      <td>4753</td>
      <td>115.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>373 rows × 5 columns</p>
</div>




```python
my_data['DGTCC'] = my_data['每日确诊'] / my_data['累计确诊'].shift(1)
my_data['DGTDC'] = my_data['每日死亡'] / my_data['累计死亡'].shift(1)
```


```python
my_data['DGTCC2'] = my_data['DGTCC'] ** 2
my_data['DGTDC2'] = my_data['DGTDC'] ** 2
```


```python
my_data['date'] = pd.to_datetime(my_data['date'])
```


```python
my_data.columns = ['trade_date', '累计确诊', '累计死亡', '每日确诊', '每日死亡', 'DGTCC', 'DGTDC', 'DGTCC2',
       'DGTDC2']
```

# 公司数据


```python
_ = pd.read_excel('全部A股非ST.xls')
_ = _.dropna()
```


```python
_.columns = ['ts_code', '证券名称', '公司英文名称']
```


```python
stock_data.shape
```




    (135617, 28)




```python
stock_data = stock_data.merge(_, on='ts_code', how='left')
```


```python
stock_data.columns = ['ts_code', 'trade_date', 'open', 'high', 'low', 'close_x',
       'pre_close', 'change', 'pct_chg', 'vol', 'amount', 'trade_date_y',
       'close_y', 'turnover_rate', 'turnover_rate_f', 'volume_ratio', 'pe',
       'pe_ttm', 'pb', 'ps', 'ps_ttm', 'dv_ratio', 'dv_ttm', 'total_share',
       'float_share', 'free_share', 'total_mv', 'circ_mv', '证券名称', '公司英文名称']
```


```python
stock_data['trade_date'] = pd.to_datetime(stock_data['trade_date'])
```


```python
my_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trade_date</th>
      <th>累计确诊</th>
      <th>累计死亡</th>
      <th>每日确诊</th>
      <th>每日死亡</th>
      <th>DGTCC</th>
      <th>DGTDC</th>
      <th>DGTCC2</th>
      <th>DGTDC2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>2019-12-02</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2019-12-03</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2019-12-04</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2019-12-05</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2019-12-06</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
stock_data = stock_data.merge(my_data, on='trade_date', how='left')
```


```python
stock_data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 135617 entries, 0 to 135616
    Data columns (total 38 columns):
     #   Column           Non-Null Count   Dtype         
    ---  ------           --------------   -----         
     0   ts_code          135617 non-null  object        
     1   trade_date       135617 non-null  datetime64[ns]
     2   open             135617 non-null  float64       
     3   high             135617 non-null  float64       
     4   low              135617 non-null  float64       
     5   close_x          135617 non-null  float64       
     6   pre_close        135617 non-null  float64       
     7   change           135617 non-null  float64       
     8   pct_chg          135617 non-null  float64       
     9   vol              135617 non-null  float64       
     10  amount           135617 non-null  float64       
     11  trade_date_y     135617 non-null  object        
     12  close_y          135617 non-null  float64       
     13  turnover_rate    135617 non-null  float64       
     14  turnover_rate_f  135617 non-null  float64       
     15  volume_ratio     135433 non-null  float64       
     16  pe               119905 non-null  float64       
     17  pe_ttm           113404 non-null  float64       
     18  pb               134405 non-null  float64       
     19  ps               135605 non-null  float64       
     20  ps_ttm           135322 non-null  float64       
     21  dv_ratio         94128 non-null   float64       
     22  dv_ttm           94122 non-null   float64       
     23  total_share      135617 non-null  float64       
     24  float_share      135617 non-null  float64       
     25  free_share       135617 non-null  float64       
     26  total_mv         135617 non-null  float64       
     27  circ_mv          135617 non-null  float64       
     28  证券名称             127685 non-null  object        
     29  公司英文名称           127685 non-null  object        
     30  累计确诊             135617 non-null  int64         
     31  累计死亡             135617 non-null  int64         
     32  每日确诊             135617 non-null  float64       
     33  每日死亡             135617 non-null  float64       
     34  DGTCC            135617 non-null  float64       
     35  DGTDC            135617 non-null  float64       
     36  DGTCC2           135617 non-null  float64       
     37  DGTDC2           135617 non-null  float64       
    dtypes: datetime64[ns](1), float64(31), int64(2), object(4)
    memory usage: 40.4+ MB
    


```python
final_data = stock_data[stock_data['证券名称'].notnull()]
```


```python
final_data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 127685 entries, 0 to 135616
    Data columns (total 38 columns):
     #   Column           Non-Null Count   Dtype         
    ---  ------           --------------   -----         
     0   ts_code          127685 non-null  object        
     1   trade_date       127685 non-null  datetime64[ns]
     2   open             127685 non-null  float64       
     3   high             127685 non-null  float64       
     4   low              127685 non-null  float64       
     5   close_x          127685 non-null  float64       
     6   pre_close        127685 non-null  float64       
     7   change           127685 non-null  float64       
     8   pct_chg          127685 non-null  float64       
     9   vol              127685 non-null  float64       
     10  amount           127685 non-null  float64       
     11  trade_date_y     127685 non-null  object        
     12  close_y          127685 non-null  float64       
     13  turnover_rate    127685 non-null  float64       
     14  turnover_rate_f  127685 non-null  float64       
     15  volume_ratio     127501 non-null  float64       
     16  pe               117547 non-null  float64       
     17  pe_ttm           111757 non-null  float64       
     18  pb               127410 non-null  float64       
     19  ps               127673 non-null  float64       
     20  ps_ttm           127619 non-null  float64       
     21  dv_ratio         93381 non-null   float64       
     22  dv_ttm           93375 non-null   float64       
     23  total_share      127685 non-null  float64       
     24  float_share      127685 non-null  float64       
     25  free_share       127685 non-null  float64       
     26  total_mv         127685 non-null  float64       
     27  circ_mv          127685 non-null  float64       
     28  证券名称             127685 non-null  object        
     29  公司英文名称           127685 non-null  object        
     30  累计确诊             127685 non-null  int64         
     31  累计死亡             127685 non-null  int64         
     32  每日确诊             127685 non-null  float64       
     33  每日死亡             127685 non-null  float64       
     34  DGTCC            127685 non-null  float64       
     35  DGTDC            127685 non-null  float64       
     36  DGTCC2           127685 non-null  float64       
     37  DGTDC2           127685 non-null  float64       
    dtypes: datetime64[ns](1), float64(31), int64(2), object(4)
    memory usage: 38.0+ MB
    


```python
final_data['账面市值比'] = final_data['pb'] / 1000
```


```python
import numpy as np

final_data['市值对数'] = np.log(final_data['total_mv'])
```


```python
fi = final_data[['trade_date', 'ts_code', '证券名称', '公司英文名称', 'close_x', 'pct_chg', '市值对数', 'pb', 'DGTCC', 'DGTCC2', 'DGTDC', 'DGTDC2']].copy()
```


```python
fi = fi[fi['trade_date'] >= '2020-01-11']
```


```python
fi = fi.sort_values(['ts_code', 'trade_date'])
```


```python
fi.columns = ['date', '股票代码', '证券名称', '公司英文名称', '收盘价', '收益率', '市值对数',
       '市值账面比', 'DGTCC', 'DGTCC2', 'DGTDC', 'DGTDC2']
```


```python
fi['new收盘价'] = fi.groupby('股票代码')['收盘价'].shift(-1)
fi['new收益率'] = fi.groupby('股票代码')['收益率'].shift(-1)
```


```python
fi02 = fi.dropna()
```


```python
fi02.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收盘价</th>
      <th>收益率</th>
      <th>市值对数</th>
      <th>市值账面比</th>
      <th>DGTCC</th>
      <th>DGTCC2</th>
      <th>DGTDC</th>
      <th>DGTDC2</th>
      <th>new收盘价</th>
      <th>new收益率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
      <td>120337.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>18.421682</td>
      <td>0.225609</td>
      <td>13.459699</td>
      <td>3.483317</td>
      <td>0.094358</td>
      <td>0.027796</td>
      <td>0.149068</td>
      <td>0.079168</td>
      <td>18.432935</td>
      <td>0.054236</td>
    </tr>
    <tr>
      <th>std</th>
      <td>33.651499</td>
      <td>5.008598</td>
      <td>1.090982</td>
      <td>4.794869</td>
      <td>0.137450</td>
      <td>0.060866</td>
      <td>0.238637</td>
      <td>0.215524</td>
      <td>33.685754</td>
      <td>3.901198</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.130000</td>
      <td>-27.120300</td>
      <td>11.570038</td>
      <td>0.319800</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.130000</td>
      <td>-27.120300</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>5.760000</td>
      <td>-1.531700</td>
      <td>12.667842</td>
      <td>1.514700</td>
      <td>0.004184</td>
      <td>0.000018</td>
      <td>0.010670</td>
      <td>0.000114</td>
      <td>5.750000</td>
      <td>-1.747600</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>10.070000</td>
      <td>0.206200</td>
      <td>13.230171</td>
      <td>2.419900</td>
      <td>0.024101</td>
      <td>0.000581</td>
      <td>0.055634</td>
      <td>0.003095</td>
      <td>10.060000</td>
      <td>0.103200</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>18.980000</td>
      <td>1.975700</td>
      <td>14.042124</td>
      <td>4.069700</td>
      <td>0.112178</td>
      <td>0.012584</td>
      <td>0.136792</td>
      <td>0.018712</td>
      <td>18.990000</td>
      <td>1.938000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1171.000000</td>
      <td>586.964700</td>
      <td>19.170706</td>
      <td>497.040100</td>
      <td>0.512027</td>
      <td>0.262172</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1171.000000</td>
      <td>108.544100</td>
    </tr>
  </tbody>
</table>
</div>




```python
# fi02.to_csv("最终整理数据.csv", encoding='utf_8_sig')
```


```python
fi02[(fi02['收益率'] < -15.0) | (fi02['收益率'] > 15.0)]['证券名称'].value_counts()
```




    优刻得-W    7
    有方科技     5
    中微公司     5
    特宝生物     4
    博瑞医药     4
            ..
    祥生医疗     1
    中国电研     1
    龙软科技     1
    和远气体     1
    金山办公     1
    Name: 证券名称, Length: 96, dtype: int64




```python
per = fi02['收益率'].quantile([0.01, 0.99])
fi03 = fi02[(fi02['收益率'] > per.loc[0.01]) & (fi02['收益率'] < per.loc[0.99])]
```


```python
fi03.to_csv("最终整理数据去尾数据.csv", encoding='utf_8_sig')
```


```python
# df = pd.read_csv("复杂数据02.csv")
```


```python
# del df['Unnamed: 0']
```


```python
# df['new收盘价'] = df.groupby('股票代码')['收盘价'].shift(-1)
# df['new收益率'] = df.groupby('股票代码')['收益率'].shift(-1)
```

# OLS 建模


```python
df = pd.read_csv("最终整理数据去尾数据.csv")
del df['Unnamed: 0']
```


```python
_ = pd.read_excel('省份.xls')
_ = _.dropna()
_ = _[['证券代码', '省份']]
_.columns = ['股票代码', '省份']
```


```python
_['是否湖北省'] = _['省份'].apply(lambda x: 1 if x == '湖北' else 0)
```


```python
_['是否湖北省'].value_counts()
```




    0    4088
    1     115
    Name: 是否湖北省, dtype: int64




```python
df = df.merge(_[['股票代码', '是否湖北省']], on='股票代码', how='left')
```


```python
df['是否湖北省'].value_counts()
```




    0    114647
    1      3282
    Name: 是否湖北省, dtype: int64




```python
# df.to_csv("最终整理数据去尾数据加省份.csv", encoding='utf_8_sig')
```


```python

```
