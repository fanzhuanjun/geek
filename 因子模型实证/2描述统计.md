```python
import numpy as np
import pandas as pd
```


```python
data = pd.read_excel("数据整理.xlsx")
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 473111 entries, 0 to 473110
    Data columns (total 32 columns):
     #   Column              Non-Null Count   Dtype         
    ---  ------              --------------   -----         
     0   证券名称                473111 non-null  object        
     1   证券代码                473111 non-null  object        
     2   日期                  473111 non-null  datetime64[ns]
     3   12个月换手率             473083 non-null  float64       
     4   20日换手率              473083 non-null  float64       
     5   PB                  473106 non-null  float64       
     6   ROA                 462750 non-null  float64       
     7   ROE                 473039 non-null  float64       
     8   动量11                470303 non-null  float64       
     9   动量6                 456282 non-null  float64       
     10  市值                  473108 non-null  float64       
     11  年化波动率               405837 non-null  float64       
     12  总资产增长率              465130 non-null  float64       
     13  收益率                 473111 non-null  float64       
     14  收盘价                 473111 non-null  float64       
     15  账面市值比               468020 non-null  float64       
     16  12个月换手率_winsorized  473111 non-null  float64       
     17  20日换手率_winsorized   473111 non-null  float64       
     18  PB_winsorized       473111 non-null  float64       
     19  ROA_winsorized      463173 non-null  float64       
     20  ROE_winsorized      473111 non-null  float64       
     21  动量11_winsorized     471664 non-null  float64       
     22  动量6_winsorized      456423 non-null  float64       
     23  市值_winsorized       473111 non-null  float64       
     24  年化波动率_winsorized    405837 non-null  float64       
     25  总资产增长率_winsorized   465229 non-null  float64       
     26  收益率_winsorized      473111 non-null  float64       
     27  收盘价_winsorized      473111 non-null  float64       
     28  账面市值比_winsorized    468149 non-null  float64       
     29  MonRf               473111 non-null  float64       
     30  mk_rf               473111 non-null  float64       
     31  收益率_rf              473111 non-null  float64       
    dtypes: datetime64[ns](1), float64(29), object(2)
    memory usage: 115.5+ MB



```python
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>证券名称</th>
      <th>证券代码</th>
      <th>日期</th>
      <th>12个月换手率</th>
      <th>20日换手率</th>
      <th>PB</th>
      <th>ROA</th>
      <th>ROE</th>
      <th>动量11</th>
      <th>动量6</th>
      <th>...</th>
      <th>动量6_winsorized</th>
      <th>市值_winsorized</th>
      <th>年化波动率_winsorized</th>
      <th>总资产增长率_winsorized</th>
      <th>收益率_winsorized</th>
      <th>收盘价_winsorized</th>
      <th>账面市值比_winsorized</th>
      <th>MonRf</th>
      <th>mk_rf</th>
      <th>收益率_rf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-01-28</td>
      <td>0.031110</td>
      <td>0.026905</td>
      <td>15.717349</td>
      <td>NaN</td>
      <td>22.3842</td>
      <td>-1.015410</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>199.160000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.171717</td>
      <td>25.04</td>
      <td>NaN</td>
      <td>0.165</td>
      <td>13.845</td>
      <td>1.006717</td>
    </tr>
    <tr>
      <th>1</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-02-29</td>
      <td>0.032089</td>
      <td>0.028986</td>
      <td>15.798949</td>
      <td>NaN</td>
      <td>22.3842</td>
      <td>-1.042668</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>213.450308</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.519169</td>
      <td>25.17</td>
      <td>NaN</td>
      <td>0.165</td>
      <td>12.825</td>
      <td>0.354169</td>
    </tr>
    <tr>
      <th>2</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-03-31</td>
      <td>0.030803</td>
      <td>0.022262</td>
      <td>7.816330</td>
      <td>NaN</td>
      <td>11.9173</td>
      <td>-0.970000</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>233.681860</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.198649</td>
      <td>25.22</td>
      <td>NaN</td>
      <td>0.165</td>
      <td>10.455</td>
      <td>0.033649</td>
    </tr>
    <tr>
      <th>3</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-04-28</td>
      <td>0.027255</td>
      <td>0.011288</td>
      <td>7.748147</td>
      <td>NaN</td>
      <td>11.9173</td>
      <td>-0.991277</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>224.853090</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.872324</td>
      <td>25.00</td>
      <td>NaN</td>
      <td>0.165</td>
      <td>1.485</td>
      <td>-1.037324</td>
    </tr>
    <tr>
      <th>4</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-05-31</td>
      <td>0.024782</td>
      <td>0.008725</td>
      <td>7.267762</td>
      <td>NaN</td>
      <td>11.9173</td>
      <td>-0.938000</td>
      <td>0.872396</td>
      <td>...</td>
      <td>0.884798</td>
      <td>235.389000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-6.200000</td>
      <td>23.45</td>
      <td>NaN</td>
      <td>0.165</td>
      <td>3.905</td>
      <td>-6.365000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 32 columns</p>
</div>




```python
data['收益率_rf'] = data['收益率'] - data['MonRf']
```


```python
data.columns
```




    Index(['证券名称', '证券代码', '日期', '12个月换手率', '20日换手率', 'PB', 'ROA', 'ROE', '动量11',
           '动量6', '市值', '年化波动率', '总资产增长率', '收益率', '收盘价', '账面市值比',
           '12个月换手率_winsorized', '20日换手率_winsorized', 'PB_winsorized',
           'ROA_winsorized', 'ROE_winsorized', '动量11_winsorized', '动量6_winsorized',
           '市值_winsorized', '年化波动率_winsorized', '总资产增长率_winsorized',
           '收益率_winsorized', '收盘价_winsorized', '账面市值比_winsorized', 'MonRf',
           'mk_rf', '收益率_rf'],
          dtype='object')




```python
# del data['收益率_winsorized']
```


```python
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 473111 entries, 0 to 473110
    Data columns (total 32 columns):
     #   Column              Non-Null Count   Dtype         
    ---  ------              --------------   -----         
     0   证券名称                473111 non-null  object        
     1   证券代码                473111 non-null  object        
     2   日期                  473111 non-null  datetime64[ns]
     3   12个月换手率             473083 non-null  float64       
     4   20日换手率              473083 non-null  float64       
     5   PB                  473106 non-null  float64       
     6   ROA                 462750 non-null  float64       
     7   ROE                 473039 non-null  float64       
     8   动量11                470303 non-null  float64       
     9   动量6                 456282 non-null  float64       
     10  市值                  473108 non-null  float64       
     11  年化波动率               405837 non-null  float64       
     12  总资产增长率              465130 non-null  float64       
     13  收益率                 473111 non-null  float64       
     14  收盘价                 473111 non-null  float64       
     15  账面市值比               468020 non-null  float64       
     16  12个月换手率_winsorized  473111 non-null  float64       
     17  20日换手率_winsorized   473111 non-null  float64       
     18  PB_winsorized       473111 non-null  float64       
     19  ROA_winsorized      463173 non-null  float64       
     20  ROE_winsorized      473111 non-null  float64       
     21  动量11_winsorized     471664 non-null  float64       
     22  动量6_winsorized      456423 non-null  float64       
     23  市值_winsorized       473111 non-null  float64       
     24  年化波动率_winsorized    405837 non-null  float64       
     25  总资产增长率_winsorized   465229 non-null  float64       
     26  收益率_winsorized      473111 non-null  float64       
     27  收盘价_winsorized      473111 non-null  float64       
     28  账面市值比_winsorized    468149 non-null  float64       
     29  MonRf               473111 non-null  float64       
     30  mk_rf               473111 non-null  float64       
     31  收益率_rf              473111 non-null  float64       
    dtypes: datetime64[ns](1), float64(29), object(2)
    memory usage: 115.5+ MB



```python
X_cols = ['市值', '账面市值比', 'ROE', '总资产增长率']
y_cols = ['年化波动率_winsorized', 'PB_winsorized', "ROA_winsorized"]
```


```python
data['总资产增长率_winsorized']
```




    0                NaN
    1                NaN
    2                NaN
    3                NaN
    4                NaN
                 ...    
    473106    215.115690
    473107     61.699599
    473108     92.167972
    473109     89.356847
    473110     84.751939
    Name: 总资产增长率_winsorized, Length: 473111, dtype: float64




```python
data['日期'] = pd.to_datetime(data['日期'])
```


```python
data2 = data[data.日期 > '2000-05-31'].copy()
```

## 将变量分成10个箱子，方便后面分组统计


```python
# def get_qcut(s):
#     try:
#         _ = pd.qcut(s, q=10, labels=range(1, 11))
#     except Exception as e:
#         a = pd.Series(range(s.shape[0]))
#         print(s.shape[0])
#         print(s)
#         print(jitter(a))
#         _ = pd.qcut(s.values+jitter(a), q=10, labels=range(1, 11))
#     return _
# def jitter(a_series, noise_reduction=1000000):
#     return (np.random.random(len(a_series))*a_series.std()/noise_reduction)-(a_series.std()/(2*noise_reduction))

def get_qcut(s):
    return pd.qcut(s, q=10, labels=range(1, 11))

for col in X_cols:
    print(col)
    data2[f'groupby_{col}'] = data2.groupby("日期")[col].apply(get_qcut)
```

    市值
    账面市值比
    ROE
    总资产增长率


# 1.	单变量排序描述性统计


```python
data2.groupby('groupby_市值')[y_cols].mean().T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>groupby_市值</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>年化波动率_winsorized</th>
      <td>47.745200</td>
      <td>46.891584</td>
      <td>47.265334</td>
      <td>47.291248</td>
      <td>47.136067</td>
      <td>47.463682</td>
      <td>47.198294</td>
      <td>46.681522</td>
      <td>45.954989</td>
      <td>43.535244</td>
    </tr>
    <tr>
      <th>PB_winsorized</th>
      <td>4.976855</td>
      <td>4.529138</td>
      <td>4.349364</td>
      <td>4.341760</td>
      <td>4.217666</td>
      <td>4.277686</td>
      <td>4.459530</td>
      <td>4.618318</td>
      <td>4.656415</td>
      <td>4.374615</td>
    </tr>
    <tr>
      <th>ROA_winsorized</th>
      <td>9.793924</td>
      <td>9.423766</td>
      <td>8.437308</td>
      <td>24.040039</td>
      <td>62.480085</td>
      <td>219.782271</td>
      <td>86.349919</td>
      <td>7.425695</td>
      <td>8.080437</td>
      <td>8.929531</td>
    </tr>
  </tbody>
</table>
</div>




```python
data2.groupby('groupby_账面市值比')[y_cols].mean().T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>groupby_账面市值比</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>年化波动率_winsorized</th>
      <td>51.996092</td>
      <td>49.231492</td>
      <td>47.681365</td>
      <td>47.311701</td>
      <td>46.167062</td>
      <td>46.006050</td>
      <td>45.072816</td>
      <td>44.641221</td>
      <td>43.935712</td>
      <td>42.240732</td>
    </tr>
    <tr>
      <th>PB_winsorized</th>
      <td>8.843647</td>
      <td>5.330965</td>
      <td>4.569087</td>
      <td>4.182618</td>
      <td>3.860983</td>
      <td>3.731455</td>
      <td>3.599685</td>
      <td>3.576051</td>
      <td>3.441293</td>
      <td>3.534984</td>
    </tr>
    <tr>
      <th>ROA_winsorized</th>
      <td>388.950549</td>
      <td>4.223765</td>
      <td>5.018257</td>
      <td>5.630087</td>
      <td>6.008061</td>
      <td>6.489011</td>
      <td>6.535087</td>
      <td>6.812140</td>
      <td>7.112918</td>
      <td>7.669678</td>
    </tr>
  </tbody>
</table>
</div>




```python
data2.groupby('groupby_ROE')[y_cols].mean().T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>groupby_ROE</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>年化波动率_winsorized</th>
      <td>50.452053</td>
      <td>47.881876</td>
      <td>47.028253</td>
      <td>47.252087</td>
      <td>46.340834</td>
      <td>45.768981</td>
      <td>45.052828</td>
      <td>44.393707</td>
      <td>44.111619</td>
      <td>47.293670</td>
    </tr>
    <tr>
      <th>PB_winsorized</th>
      <td>5.644084</td>
      <td>3.769239</td>
      <td>3.530069</td>
      <td>3.494509</td>
      <td>3.582254</td>
      <td>3.762879</td>
      <td>3.966461</td>
      <td>4.394449</td>
      <td>4.972480</td>
      <td>7.679088</td>
    </tr>
    <tr>
      <th>ROA_winsorized</th>
      <td>372.885285</td>
      <td>1.183358</td>
      <td>3.112321</td>
      <td>4.322708</td>
      <td>5.328956</td>
      <td>6.238589</td>
      <td>7.355321</td>
      <td>8.804724</td>
      <td>12.629790</td>
      <td>21.765703</td>
    </tr>
  </tbody>
</table>
</div>




```python
data2.groupby('groupby_总资产增长率')[y_cols].mean().T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>groupby_总资产增长率</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>年化波动率_winsorized</th>
      <td>49.855307</td>
      <td>46.596512</td>
      <td>45.698557</td>
      <td>45.515613</td>
      <td>44.859126</td>
      <td>45.177458</td>
      <td>45.203800</td>
      <td>45.949210</td>
      <td>47.380813</td>
      <td>51.768405</td>
    </tr>
    <tr>
      <th>PB_winsorized</th>
      <td>5.533384</td>
      <td>4.305713</td>
      <td>3.910544</td>
      <td>3.945088</td>
      <td>3.929697</td>
      <td>4.028173</td>
      <td>4.221320</td>
      <td>4.390642</td>
      <td>4.800602</td>
      <td>5.373751</td>
    </tr>
    <tr>
      <th>ROA_winsorized</th>
      <td>391.616094</td>
      <td>3.128808</td>
      <td>4.625328</td>
      <td>5.692145</td>
      <td>6.354487</td>
      <td>6.840201</td>
      <td>7.206005</td>
      <td>7.360716</td>
      <td>8.252740</td>
      <td>8.454850</td>
    </tr>
  </tbody>
</table>
</div>



# 计算每个组合的月平均收益率


```python
from scipy import stats
```


```python
o1 = data2.groupby('groupby_市值')['收益率'].mean()
o2 = data2.groupby('groupby_市值')['收益率'].apply(lambda x: stats.ttest_1samp(x, 0)[0])
o2.name='t值'
pd.concat([o1, o2], axis=1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收益率</th>
      <th>t值</th>
    </tr>
    <tr>
      <th>groupby_市值</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.072876</td>
      <td>-0.959868</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.631738</td>
      <td>8.287579</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.079712</td>
      <td>13.499996</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.556404</td>
      <td>18.324643</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.585423</td>
      <td>18.947943</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.846345</td>
      <td>21.222868</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.993323</td>
      <td>25.287149</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1.930949</td>
      <td>25.588854</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2.342954</td>
      <td>25.137450</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2.096888</td>
      <td>29.419833</td>
    </tr>
  </tbody>
</table>
</div>




```python
o1 = data2.groupby('groupby_账面市值比')['收益率'].mean()
o2 = data2.groupby('groupby_账面市值比')['收益率'].apply(lambda x: stats.ttest_1samp(x, 0)[0])
o2.name='t值'
pd.concat([o1, o2], axis=1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收益率</th>
      <th>t值</th>
    </tr>
    <tr>
      <th>groupby_账面市值比</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1.328757</td>
      <td>14.358755</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.345408</td>
      <td>14.587092</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.276979</td>
      <td>17.297310</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.373541</td>
      <td>18.096347</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.462299</td>
      <td>18.817401</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.447490</td>
      <td>18.712015</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.760596</td>
      <td>20.793623</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1.761416</td>
      <td>21.387750</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1.668401</td>
      <td>21.391383</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.604030</td>
      <td>21.881062</td>
    </tr>
  </tbody>
</table>
</div>




```python
o1 = data2.groupby('groupby_ROE')['收益率'].mean()
o2 = data2.groupby('groupby_ROE')['收益率'].apply(lambda x: stats.ttest_1samp(x, 0)[0])
o2.name='t值'
pd.concat([o1, o2], axis=1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收益率</th>
      <th>t值</th>
    </tr>
    <tr>
      <th>groupby_ROE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1.031304</td>
      <td>13.420540</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.975530</td>
      <td>14.049201</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.077365</td>
      <td>15.894713</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.054459</td>
      <td>15.735016</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.128987</td>
      <td>16.507724</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.173537</td>
      <td>16.801702</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.343365</td>
      <td>18.794959</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1.675890</td>
      <td>21.185996</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2.256794</td>
      <td>23.619802</td>
    </tr>
    <tr>
      <th>10</th>
      <td>3.266677</td>
      <td>26.206651</td>
    </tr>
  </tbody>
</table>
</div>




```python
o1 = data2.groupby('groupby_总资产增长率')['收益率'].mean()
o2 = data2.groupby('groupby_总资产增长率')['收益率'].apply(lambda x: stats.ttest_1samp(x, 0)[0])
o2.name='t值'
pd.concat([o1, o2], axis=1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收益率</th>
      <th>t值</th>
    </tr>
    <tr>
      <th>groupby_总资产增长率</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1.256736</td>
      <td>15.554880</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.306948</td>
      <td>17.269182</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.426977</td>
      <td>19.330187</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.470108</td>
      <td>17.746000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.539532</td>
      <td>19.442149</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.601987</td>
      <td>20.307117</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.723948</td>
      <td>20.393851</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1.642709</td>
      <td>20.947452</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1.639542</td>
      <td>20.294546</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.631086</td>
      <td>16.855427</td>
    </tr>
  </tbody>
</table>
</div>



# 2.	独立双重排序：

## 变量每个时段分成5个组


```python
def get_qcut_q5(s):
    return pd.qcut(s, q=5, labels=range(1, 6))

for col in X_cols:
    print(col)
    data2[f'group5by_{col}'] = data2.groupby("日期")[col].apply(get_qcut_q5)
```

    市值
    账面市值比
    ROE
    总资产增长率



```python
data2['group_市值_账面市值比'] = data2['group5by_市值'].astype("str") + data2['group5by_账面市值比'].astype("str")
data2['group_市值_ROE'] = data2['group5by_市值'].astype("str") + data2['group5by_ROE'].astype("str")
data2['group_市值_总资产增长率'] = data2['group5by_市值'].astype("str") + data2['group5by_总资产增长率'].astype("str")
```


```python
pd.pivot_table(data2, index='group5by_市值', columns='group5by_账面市值比', values='收益率', aggfunc=np.mean)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_账面市值比</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.146367</td>
      <td>-0.098878</td>
      <td>0.470547</td>
      <td>0.904702</td>
      <td>0.123278</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.276301</td>
      <td>1.157829</td>
      <td>1.119606</td>
      <td>1.718587</td>
      <td>1.399016</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.851607</td>
      <td>1.590387</td>
      <td>1.620978</td>
      <td>1.817588</td>
      <td>1.742512</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.094213</td>
      <td>1.786789</td>
      <td>1.815944</td>
      <td>1.827164</td>
      <td>2.320639</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3.085286</td>
      <td>2.281061</td>
      <td>2.087113</td>
      <td>2.343285</td>
      <td>1.902977</td>
    </tr>
  </tbody>
</table>
</div>




```python
# t检验
pd.pivot_table(data2, index='group5by_市值', columns='group5by_账面市值比', values='收益率', aggfunc=lambda x: stats.ttest_1samp(x, 0)[0])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_账面市值比</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1.762303</td>
      <td>-0.900084</td>
      <td>3.430488</td>
      <td>5.833226</td>
      <td>0.798092</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.699848</td>
      <td>10.090535</td>
      <td>9.171547</td>
      <td>11.902407</td>
      <td>9.852339</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11.198844</td>
      <td>13.245136</td>
      <td>13.292828</td>
      <td>13.215000</td>
      <td>13.320578</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14.466611</td>
      <td>15.267481</td>
      <td>15.640310</td>
      <td>15.434023</td>
      <td>19.490807</td>
    </tr>
    <tr>
      <th>5</th>
      <td>9.121121</td>
      <td>17.494039</td>
      <td>17.757963</td>
      <td>21.244043</td>
      <td>22.764833</td>
    </tr>
  </tbody>
</table>
</div>




```python
pd.pivot_table(data2, index='group5by_市值', columns='group5by_ROE', values='收益率', aggfunc=np.mean)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_ROE</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.011480</td>
      <td>-0.113675</td>
      <td>-0.390215</td>
      <td>0.299999</td>
      <td>4.049989</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.976399</td>
      <td>0.942750</td>
      <td>1.058571</td>
      <td>1.273961</td>
      <td>3.483611</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.730210</td>
      <td>1.395897</td>
      <td>1.427646</td>
      <td>1.525359</td>
      <td>2.854966</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.067364</td>
      <td>1.917478</td>
      <td>1.622553</td>
      <td>1.911316</td>
      <td>2.280324</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2.066474</td>
      <td>1.887105</td>
      <td>2.141727</td>
      <td>1.920129</td>
      <td>2.551167</td>
    </tr>
  </tbody>
</table>
</div>




```python
# t检验
pd.pivot_table(data2, index='group5by_市值', columns='group5by_ROE', values='收益率', aggfunc=lambda x: stats.ttest_1samp(x, 0)[0])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_ROE</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.147852</td>
      <td>-1.281367</td>
      <td>-3.836626</td>
      <td>1.793825</td>
      <td>11.969428</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9.536888</td>
      <td>9.993364</td>
      <td>10.431839</td>
      <td>9.685236</td>
      <td>11.243693</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.420280</td>
      <td>13.503162</td>
      <td>13.354947</td>
      <td>13.401013</td>
      <td>12.239258</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14.264846</td>
      <td>16.116341</td>
      <td>15.115780</td>
      <td>18.631995</td>
      <td>17.035293</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10.901359</td>
      <td>12.397000</td>
      <td>16.101269</td>
      <td>18.353647</td>
      <td>24.292623</td>
    </tr>
  </tbody>
</table>
</div>




```python
pd.pivot_table(data2, index='group5by_市值', columns='group5by_总资产增长率', values='收益率', aggfunc=np.mean)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_总资产增长率</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.306344</td>
      <td>0.475323</td>
      <td>0.469039</td>
      <td>0.634005</td>
      <td>-0.497229</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.308364</td>
      <td>1.414942</td>
      <td>1.799198</td>
      <td>1.348665</td>
      <td>0.843437</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.994489</td>
      <td>1.723523</td>
      <td>1.606801</td>
      <td>1.758012</td>
      <td>1.653877</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.168215</td>
      <td>1.775937</td>
      <td>1.790696</td>
      <td>2.007598</td>
      <td>2.162463</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1.671191</td>
      <td>2.110344</td>
      <td>1.966391</td>
      <td>2.186485</td>
      <td>2.871306</td>
    </tr>
  </tbody>
</table>
</div>




```python
# t检验
pd.pivot_table(data2, index='group5by_市值', columns='group5by_总资产增长率', values='收益率', aggfunc=lambda x: stats.ttest_1samp(x, 0)[0])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>group5by_总资产增长率</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
    <tr>
      <th>group5by_市值</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>3.514125</td>
      <td>4.267407</td>
      <td>3.383278</td>
      <td>3.854415</td>
      <td>-3.520400</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11.280211</td>
      <td>11.051283</td>
      <td>12.752609</td>
      <td>9.393102</td>
      <td>6.457223</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13.020002</td>
      <td>14.007985</td>
      <td>12.903051</td>
      <td>13.341812</td>
      <td>11.250669</td>
    </tr>
    <tr>
      <th>4</th>
      <td>15.373054</td>
      <td>14.691100</td>
      <td>14.839275</td>
      <td>16.789477</td>
      <td>18.795961</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10.831805</td>
      <td>15.191468</td>
      <td>18.972450</td>
      <td>21.229940</td>
      <td>18.908262</td>
    </tr>
  </tbody>
</table>
</div>




```python
data2.to_excel("数据整理_2.xlsx", index=None)
```


```python
data2
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>证券名称</th>
      <th>证券代码</th>
      <th>日期</th>
      <th>12个月换手率</th>
      <th>20日换手率</th>
      <th>PB</th>
      <th>ROA</th>
      <th>ROE</th>
      <th>动量11</th>
      <th>动量6</th>
      <th>...</th>
      <th>groupby_ROE</th>
      <th>groupby_账面市值比</th>
      <th>groupby_总资产增长率</th>
      <th>group5by_市值</th>
      <th>group5by_账面市值比</th>
      <th>group5by_ROE</th>
      <th>group5by_总资产增长率</th>
      <th>group_市值_账面市值比</th>
      <th>group_市值_ROE</th>
      <th>group_市值_总资产增长率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-06-30</td>
      <td>0.022179</td>
      <td>0.007204</td>
      <td>7.298754</td>
      <td>NaN</td>
      <td>11.9173</td>
      <td>-0.993671</td>
      <td>0.936382</td>
      <td>...</td>
      <td>8</td>
      <td>9</td>
      <td>8</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
      <td>55</td>
      <td>54</td>
      <td>54</td>
    </tr>
    <tr>
      <th>6</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-07-31</td>
      <td>0.020388</td>
      <td>0.007807</td>
      <td>6.977880</td>
      <td>NaN</td>
      <td>11.4490</td>
      <td>-1.042031</td>
      <td>1.001091</td>
      <td>...</td>
      <td>8</td>
      <td>9</td>
      <td>8</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
      <td>55</td>
      <td>54</td>
      <td>54</td>
    </tr>
    <tr>
      <th>7</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-08-31</td>
      <td>0.018546</td>
      <td>0.004914</td>
      <td>6.745767</td>
      <td>NaN</td>
      <td>11.4490</td>
      <td>-0.972803</td>
      <td>0.886408</td>
      <td>...</td>
      <td>8</td>
      <td>9</td>
      <td>8</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
      <td>55</td>
      <td>54</td>
      <td>54</td>
    </tr>
    <tr>
      <th>8</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-09-29</td>
      <td>0.017109</td>
      <td>0.003844</td>
      <td>6.267036</td>
      <td>NaN</td>
      <td>11.4490</td>
      <td>-0.931034</td>
      <td>0.846261</td>
      <td>...</td>
      <td>8</td>
      <td>9</td>
      <td>8</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
      <td>55</td>
      <td>54</td>
      <td>54</td>
    </tr>
    <tr>
      <th>9</th>
      <td>浦发银行</td>
      <td>600000.SH</td>
      <td>2000-10-31</td>
      <td>0.016035</td>
      <td>0.002482</td>
      <td>6.179993</td>
      <td>NaN</td>
      <td>11.4490</td>
      <td>-0.993934</td>
      <td>0.877548</td>
      <td>...</td>
      <td>8</td>
      <td>9</td>
      <td>8</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
      <td>55</td>
      <td>54</td>
      <td>54</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>473106</th>
      <td>久量股份</td>
      <td>300808.SZ</td>
      <td>2019-11-29</td>
      <td>0.008434</td>
      <td>0.008434</td>
      <td>3.931479</td>
      <td>10.6496</td>
      <td>14.3029</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>9</td>
      <td>7</td>
      <td>NaN</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>NaN</td>
      <td>24</td>
      <td>25</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>473107</th>
      <td>久量股份</td>
      <td>300808.SZ</td>
      <td>2019-12-31</td>
      <td>0.149152</td>
      <td>0.170854</td>
      <td>6.038158</td>
      <td>7.4647</td>
      <td>14.3029</td>
      <td>-1.269231</td>
      <td>NaN</td>
      <td>...</td>
      <td>9</td>
      <td>8</td>
      <td>10</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>5</td>
      <td>24</td>
      <td>25</td>
      <td>25</td>
    </tr>
    <tr>
      <th>473108</th>
      <td>华辰装备</td>
      <td>300809.SZ</td>
      <td>2019-12-31</td>
      <td>0.202278</td>
      <td>0.202278</td>
      <td>6.219616</td>
      <td>9.7420</td>
      <td>23.6715</td>
      <td>-1.442728</td>
      <td>NaN</td>
      <td>...</td>
      <td>10</td>
      <td>9</td>
      <td>10</td>
      <td>3</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>35</td>
      <td>35</td>
      <td>35</td>
    </tr>
    <tr>
      <th>473109</th>
      <td>中科海讯</td>
      <td>300810.SZ</td>
      <td>2019-12-31</td>
      <td>0.096853</td>
      <td>0.096853</td>
      <td>10.979098</td>
      <td>8.2918</td>
      <td>20.9846</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>3</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>35</td>
      <td>35</td>
      <td>35</td>
    </tr>
    <tr>
      <th>473110</th>
      <td>铂科新材</td>
      <td>300811.SZ</td>
      <td>2019-12-31</td>
      <td>0.002417</td>
      <td>0.002417</td>
      <td>5.657912</td>
      <td>10.7744</td>
      <td>19.7984</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>10</td>
      <td>10</td>
      <td>10</td>
      <td>1</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
<p>468906 rows × 43 columns</p>
</div>

