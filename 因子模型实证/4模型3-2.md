```python
import numpy as np
import pandas as pd
import os
```


```python
factor_df = pd.read_excel("五因子数据.xlsx")
factor_df = factor_df.rename(columns={"时间" : "日期"})
```


```python
factor_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>SMB</th>
      <th>HML</th>
      <th>CMA</th>
      <th>RMW</th>
      <th>mk_rf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>1.776700</td>
      <td>-2.048085</td>
      <td>-3.020902</td>
      <td>-3.910493</td>
      <td>4.985</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>2.161310</td>
      <td>-3.355225</td>
      <td>-2.356352</td>
      <td>-3.563212</td>
      <td>0.555</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>2.768764</td>
      <td>-0.595435</td>
      <td>-0.795055</td>
      <td>-0.294096</td>
      <td>-3.895</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>2.368923</td>
      <td>0.203406</td>
      <td>-1.691315</td>
      <td>-2.593286</td>
      <td>3.545</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>0.514857</td>
      <td>0.213481</td>
      <td>0.095284</td>
      <td>-0.527789</td>
      <td>6.015</td>
    </tr>
  </tbody>
</table>
</div>




```python
data = pd.read_excel("数据整理_2.xlsx")
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 468906 entries, 0 to 468905
    Data columns (total 43 columns):
     #   Column                 Non-Null Count   Dtype         
    ---  ------                 --------------   -----         
     0   证券名称                   468906 non-null  object        
     1   证券代码                   468906 non-null  object        
     2   日期                     468906 non-null  datetime64[ns]
     3   12个月换手率                468883 non-null  float64       
     4   20日换手率                 468883 non-null  float64       
     5   PB                     468904 non-null  float64       
     6   ROA                    462750 non-null  float64       
     7   ROE                    468850 non-null  float64       
     8   动量11                   466135 non-null  float64       
     9   动量6                    452273 non-null  float64       
     10  市值                     468906 non-null  float64       
     11  年化波动率                  402545 non-null  float64       
     12  总资产增长率                 465130 non-null  float64       
     13  收益率                    468906 non-null  float64       
     14  收盘价                    468906 non-null  float64       
     15  账面市值比                  468020 non-null  float64       
     16  12个月换手率_winsorized     468906 non-null  float64       
     17  20日换手率_winsorized      468906 non-null  float64       
     18  PB_winsorized          468906 non-null  float64       
     19  ROA_winsorized         463173 non-null  float64       
     20  ROE_winsorized         468906 non-null  float64       
     21  动量11_winsorized        467478 non-null  float64       
     22  动量6_winsorized         452414 non-null  float64       
     23  市值_winsorized          468906 non-null  float64       
     24  年化波动率_winsorized       402545 non-null  float64       
     25  总资产增长率_winsorized      465229 non-null  float64       
     26  收盘价_winsorized         468906 non-null  float64       
     27  账面市值比_winsorized       468149 non-null  float64       
     28  MonRf                  468906 non-null  float64       
     29  mk_rf                  468906 non-null  float64       
     30  收益率_rf                 468906 non-null  float64       
     31  groupby_市值_winsorized  468906 non-null  int64         
     32  groupby_市值             468906 non-null  int64         
     33  groupby_ROE            468850 non-null  float64       
     34  groupby_账面市值比          468020 non-null  float64       
     35  groupby_总资产增长率         465130 non-null  float64       
     36  group5by_市值            468906 non-null  int64         
     37  group5by_账面市值比         468020 non-null  float64       
     38  group5by_ROE           468850 non-null  float64       
     39  group5by_总资产增长率        465130 non-null  float64       
     40  group_市值_账面市值比         468020 non-null  float64       
     41  group_市值_ROE           468850 non-null  float64       
     42  group_市值_总资产增长率        465130 non-null  float64       
    dtypes: datetime64[ns](1), float64(37), int64(3), object(2)
    memory usage: 153.8+ MB
    


```python
def get_qc(s):
    s2 = s.copy()
    border_down1, border_up1 = s.quantile([0.3, 0.7])
    
    s2[s>=border_up1] = 3
    s2[(s>=border_down1) & (s<border_up1)] = 2
    s2[s<border_down1] = 1
    return s2
```


```python
data['市值大小分组'] = data.groupby("日期")['市值_winsorized'].apply(lambda x: pd.qcut(x, q=2, labels=range(1, 3)))
```


```python
data['账面市值比3070'] = data.groupby("日期")['账面市值比'].apply(lambda x: get_qc(x))
data['ROE3070'] = data.groupby("日期")['ROE'].apply(lambda x: get_qc(x))
data['总资产增长率3070'] = data.groupby("日期")['总资产增长率'].apply(lambda x: get_qc(x))
```


```python
data['3070_市值_账面市值比'] = data['市值大小分组'].astype("str") + data['账面市值比3070'].astype("str")
data['3070_市值_ROE'] = data['市值大小分组'].astype("str") + data['ROE3070'].astype("str")
data['3070_市值_总资产增长率'] = data['市值大小分组'].astype("str") + data['总资产增长率3070'].astype("str")
```


```python
import statsmodels.api as sm

def get_OLS(X, y):
    X = sm.add_constant(X)
    mod = sm.OLS(y, X)
    res = mod.fit()
    return res
```


```python
data['市值_winsorized_lag1'] = data.groupby("证券代码")['市值_winsorized'].shift(1)
data['账面市值比_winsorized_lag1'] = data.groupby("证券代码")['账面市值比_winsorized'].shift(1)
data['ROE_winsorized_lag1'] = data.groupby("证券代码")['ROE_winsorized'].shift(1)
data['总资产增长率_winsorized_lag1'] = data.groupby("证券代码")['总资产增长率_winsorized'].shift(1)
```


```python
data.columns
```




    Index(['证券名称', '证券代码', '日期', '12个月换手率', '20日换手率', 'PB', 'ROA', 'ROE', '动量11',
           '动量6', '市值', '年化波动率', '总资产增长率', '收益率', '收盘价', '账面市值比',
           '12个月换手率_winsorized', '20日换手率_winsorized', 'PB_winsorized',
           'ROA_winsorized', 'ROE_winsorized', '动量11_winsorized', '动量6_winsorized',
           '市值_winsorized', '年化波动率_winsorized', '总资产增长率_winsorized',
           '收盘价_winsorized', '账面市值比_winsorized', 'MonRf', 'mk_rf', '收益率_rf',
           'groupby_市值_winsorized', 'groupby_市值', 'groupby_ROE', 'groupby_账面市值比',
           'groupby_总资产增长率', 'group5by_市值', 'group5by_账面市值比', 'group5by_ROE',
           'group5by_总资产增长率', 'group_市值_账面市值比', 'group_市值_ROE', 'group_市值_总资产增长率',
           '市值大小分组', '账面市值比3070', 'ROE3070', '总资产增长率3070', '3070_市值_账面市值比',
           '3070_市值_ROE', '3070_市值_总资产增长率', '市值_winsorized_lag1',
           '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1',
           '总资产增长率_winsorized_lag1'],
          dtype='object')




```python
portfolio_df = pd.DataFrame()

for col in ['3070_市值_账面市值比', '3070_市值_ROE', '3070_市值_总资产增长率']:
    _ = data.groupby(["日期", col])[['收益率', '收益率_rf', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']].mean().reset_index()
    _[col] = _[col].apply(lambda x: col + '_' + str(x))
    _.columns = ['日期', '投资组合', '收益率', '收益率_rf', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']
    portfolio_df = portfolio_df.append(_)
```


```python
portfolio_df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 4451 entries, 0 to 1525
    Data columns (total 8 columns):
     #   Column                  Non-Null Count  Dtype         
    ---  ------                  --------------  -----         
     0   日期                      4451 non-null   datetime64[ns]
     1   投资组合                    4451 non-null   object        
     2   收益率                     4451 non-null   float64       
     3   收益率_rf                  4451 non-null   float64       
     4   市值_winsorized_lag1      4413 non-null   float64       
     5   账面市值比_winsorized_lag1   4385 non-null   float64       
     6   ROE_winsorized_lag1     4413 non-null   float64       
     7   总资产增长率_winsorized_lag1  4313 non-null   float64       
    dtypes: datetime64[ns](1), float64(6), object(1)
    memory usage: 313.0+ KB
    


```python
portfolio_df_drop = portfolio_df.dropna()
```


```python
portfolio_df_drop.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>投资组合</th>
      <th>收益率</th>
      <th>收益率_rf</th>
      <th>市值_winsorized_lag1</th>
      <th>账面市值比_winsorized_lag1</th>
      <th>ROE_winsorized_lag1</th>
      <th>总资产增长率_winsorized_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_11.0</td>
      <td>7.463308</td>
      <td>7.298308</td>
      <td>19.698026</td>
      <td>1.407790</td>
      <td>-12.149504</td>
      <td>4.171986</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_12.0</td>
      <td>3.989139</td>
      <td>3.824139</td>
      <td>22.434397</td>
      <td>2.595973</td>
      <td>7.783719</td>
      <td>18.399904</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_13.0</td>
      <td>3.204412</td>
      <td>3.039412</td>
      <td>23.248663</td>
      <td>3.623684</td>
      <td>9.487779</td>
      <td>27.058535</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_21.0</td>
      <td>4.476541</td>
      <td>4.311541</td>
      <td>66.542175</td>
      <td>1.630908</td>
      <td>7.979761</td>
      <td>19.111729</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_22.0</td>
      <td>5.557927</td>
      <td>5.392927</td>
      <td>60.864011</td>
      <td>2.587372</td>
      <td>10.827089</td>
      <td>20.530862</td>
    </tr>
  </tbody>
</table>
</div>




```python
portfolio_df_drop = portfolio_df_drop.reset_index().drop("index", axis=1)
```


```python
for col in ['市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']:
    portfolio_df_drop[f'{col}_scaled'] = portfolio_df_drop.groupby('日期')[col].apply(lambda x: (x - np.mean(x)) / (np.std(x)))
```


```python
portfolio_df_drop.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>投资组合</th>
      <th>收益率</th>
      <th>收益率_rf</th>
      <th>市值_winsorized_lag1</th>
      <th>账面市值比_winsorized_lag1</th>
      <th>ROE_winsorized_lag1</th>
      <th>总资产增长率_winsorized_lag1</th>
      <th>市值_winsorized_lag1_scaled</th>
      <th>账面市值比_winsorized_lag1_scaled</th>
      <th>ROE_winsorized_lag1_scaled</th>
      <th>总资产增长率_winsorized_lag1_scaled</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_11.0</td>
      <td>7.463308</td>
      <td>7.298308</td>
      <td>19.698026</td>
      <td>1.407790</td>
      <td>-12.149504</td>
      <td>4.171986</td>
      <td>-0.968228</td>
      <td>-1.290330</td>
      <td>-1.344756</td>
      <td>-0.699669</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_12.0</td>
      <td>3.989139</td>
      <td>3.824139</td>
      <td>22.434397</td>
      <td>2.595973</td>
      <td>7.783719</td>
      <td>18.399904</td>
      <td>-0.848692</td>
      <td>0.161483</td>
      <td>-0.057755</td>
      <td>0.014129</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_13.0</td>
      <td>3.204412</td>
      <td>3.039412</td>
      <td>23.248663</td>
      <td>3.623684</td>
      <td>9.487779</td>
      <td>27.058535</td>
      <td>-0.813121</td>
      <td>1.417219</td>
      <td>0.052268</td>
      <td>0.448523</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_21.0</td>
      <td>4.476541</td>
      <td>4.311541</td>
      <td>66.542175</td>
      <td>1.630908</td>
      <td>7.979761</td>
      <td>19.111729</td>
      <td>1.078116</td>
      <td>-1.017706</td>
      <td>-0.045098</td>
      <td>0.049841</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-07-31</td>
      <td>3070_市值_账面市值比_22.0</td>
      <td>5.557927</td>
      <td>5.392927</td>
      <td>60.864011</td>
      <td>2.587372</td>
      <td>10.827089</td>
      <td>20.530862</td>
      <td>0.830070</td>
      <td>0.150974</td>
      <td>0.138742</td>
      <td>0.121037</td>
    </tr>
  </tbody>
</table>
</div>




```python
factor_ex = []

for i in list(portfolio_df_drop['日期'].unique()):
    _ = portfolio_df_drop[portfolio_df_drop['日期'] == i].copy()
    
    X = _[['市值_winsorized_lag1_scaled', '账面市值比_winsorized_lag1_scaled', 'ROE_winsorized_lag1_scaled', '总资产增长率_winsorized_lag1_scaled']]
    y = _['收益率_rf']
    res = get_OLS(X, y)
    
    n = [i, *list(res.params.values)]
    factor_ex.append(n)
```


```python
df_ex = pd.DataFrame(factor_ex, columns=['日期', 'const', '市值因子收益率', '账面市值比因子收益率', 'ROE因子收益率', '总资产增长率因子收益率'])
```


```python
df_ex.to_excel("因子收益率.xlsx", index=None)
```


```python
df_ex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>const</th>
      <th>市值因子收益率</th>
      <th>账面市值比因子收益率</th>
      <th>ROE因子收益率</th>
      <th>总资产增长率因子收益率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>5.819702</td>
      <td>-0.063955</td>
      <td>-1.781308</td>
      <td>1.850489</td>
      <td>-1.612875</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>1.139063</td>
      <td>-0.155462</td>
      <td>-1.870000</td>
      <td>0.991164</td>
      <td>-0.982347</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>-3.225288</td>
      <td>-0.811375</td>
      <td>-1.039938</td>
      <td>1.483239</td>
      <td>-0.788082</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>3.815990</td>
      <td>-0.923542</td>
      <td>0.028459</td>
      <td>0.642535</td>
      <td>-1.010535</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>6.247308</td>
      <td>0.195750</td>
      <td>-0.010602</td>
      <td>0.829874</td>
      <td>-0.549144</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>229</th>
      <td>2019-08-30</td>
      <td>0.024970</td>
      <td>-1.603765</td>
      <td>-1.797194</td>
      <td>1.569650</td>
      <td>5.243653</td>
    </tr>
    <tr>
      <th>230</th>
      <td>2019-09-30</td>
      <td>3.709445</td>
      <td>-0.275807</td>
      <td>0.047775</td>
      <td>0.561623</td>
      <td>8.378270</td>
    </tr>
    <tr>
      <th>231</th>
      <td>2019-10-31</td>
      <td>-0.048894</td>
      <td>0.949830</td>
      <td>-0.856272</td>
      <td>0.184950</td>
      <td>2.475208</td>
    </tr>
    <tr>
      <th>232</th>
      <td>2019-11-29</td>
      <td>-0.104088</td>
      <td>1.247764</td>
      <td>-0.353185</td>
      <td>-2.518392</td>
      <td>9.851999</td>
    </tr>
    <tr>
      <th>233</th>
      <td>2019-12-31</td>
      <td>8.317079</td>
      <td>0.323752</td>
      <td>-0.006101</td>
      <td>-0.076123</td>
      <td>0.311451</td>
    </tr>
  </tbody>
</table>
<p>234 rows × 6 columns</p>
</div>




```python
portfolio_dat = pd.DataFrame()

for col in ['group_市值_账面市值比', 'group_市值_ROE', 'group_市值_总资产增长率']:
    _ = data.groupby(["日期", col])[['收益率', '收益率_rf', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']].mean().reset_index()
    _[col] = _[col].apply(lambda x: col + '_' + str(x))
    _.columns = ['日期', '投资组合', '收益率', '收益率_rf', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']
    portfolio_dat = portfolio_dat.append(_)
```


```python
portfolio_dat_f = portfolio_dat.merge(df_ex, on='日期', how='left').dropna()
```


```python
portfolio_dat_f.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 17550 entries, 25 to 17624
    Data columns (total 13 columns):
     #   Column                  Non-Null Count  Dtype         
    ---  ------                  --------------  -----         
     0   日期                      17550 non-null  datetime64[ns]
     1   投资组合                    17550 non-null  object        
     2   收益率                     17550 non-null  float64       
     3   收益率_rf                  17550 non-null  float64       
     4   市值_winsorized_lag1      17550 non-null  float64       
     5   账面市值比_winsorized_lag1   17550 non-null  float64       
     6   ROE_winsorized_lag1     17550 non-null  float64       
     7   总资产增长率_winsorized_lag1  17550 non-null  float64       
     8   const                   17550 non-null  float64       
     9   市值因子收益率                 17550 non-null  float64       
     10  账面市值比因子收益率              17550 non-null  float64       
     11  ROE因子收益率                17550 non-null  float64       
     12  总资产增长率因子收益率             17550 non-null  float64       
    dtypes: datetime64[ns](1), float64(11), object(1)
    memory usage: 1.9+ MB
    


```python
portfolio_dat_f['预期收益率'] = portfolio_dat_f['const'] + portfolio_dat_f['市值_winsorized_lag1'] * portfolio_dat_f['市值因子收益率'] \
 + portfolio_dat_f['账面市值比因子收益率'] * portfolio_dat_f['账面市值比_winsorized_lag1'] \
 + portfolio_dat_f['ROE因子收益率'] * portfolio_dat_f['ROE_winsorized_lag1'] \
 + portfolio_dat_f['总资产增长率因子收益率'] * portfolio_dat_f['总资产增长率_winsorized_lag1'] 
```


```python
portfolio_dat_f['超额alpha'] = portfolio_dat_f['收益率'] - portfolio_dat_f['预期收益率']
```


```python
portfolio_dat_f.groupby("投资组合")['超额alpha'].mean()
```




    投资组合
    group_市值_ROE_11.0        3.182320
    group_市值_ROE_12.0       -5.046465
    group_市值_ROE_13.0       -6.175054
    group_市值_ROE_14.0       -5.797301
    group_市值_ROE_15.0       -4.031642
                              ...    
    group_市值_账面市值比_51.0   -118.774449
    group_市值_账面市值比_52.0    -98.818054
    group_市值_账面市值比_53.0   -107.141622
    group_市值_账面市值比_54.0   -103.601172
    group_市值_账面市值比_55.0   -115.417505
    Name: 超额alpha, Length: 75, dtype: float64




```python
portfolio_dat_f.to_excel("75个投资组合.xlsx", index=None)
```
