```python
import numpy as np
import pandas as pd
import os
```


```python
factor_df = pd.read_excel("五因子数据.xlsx")
factor_df = factor_df.rename(columns={"时间" : "日期"})
```


```python
factor_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>SMB</th>
      <th>HML</th>
      <th>CMA</th>
      <th>RMW</th>
      <th>mk_rf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>1.776700</td>
      <td>-2.048085</td>
      <td>-3.020902</td>
      <td>-3.910493</td>
      <td>4.985</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>2.161310</td>
      <td>-3.355225</td>
      <td>-2.356352</td>
      <td>-3.563212</td>
      <td>0.555</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>2.768764</td>
      <td>-0.595435</td>
      <td>-0.795055</td>
      <td>-0.294096</td>
      <td>-3.895</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>2.368923</td>
      <td>0.203406</td>
      <td>-1.691315</td>
      <td>-2.593286</td>
      <td>3.545</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>0.514857</td>
      <td>0.213481</td>
      <td>0.095284</td>
      <td>-0.527789</td>
      <td>6.015</td>
    </tr>
  </tbody>
</table>
</div>




```python
data = pd.read_excel("数据整理_2.xlsx")
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 468906 entries, 0 to 468905
    Data columns (total 43 columns):
     #   Column                 Non-Null Count   Dtype         
    ---  ------                 --------------   -----         
     0   证券名称                   468906 non-null  object        
     1   证券代码                   468906 non-null  object        
     2   日期                     468906 non-null  datetime64[ns]
     3   12个月换手率                468883 non-null  float64       
     4   20日换手率                 468883 non-null  float64       
     5   PB                     468904 non-null  float64       
     6   ROA                    462750 non-null  float64       
     7   ROE                    468850 non-null  float64       
     8   动量11                   466135 non-null  float64       
     9   动量6                    452273 non-null  float64       
     10  市值                     468906 non-null  float64       
     11  年化波动率                  402545 non-null  float64       
     12  总资产增长率                 465130 non-null  float64       
     13  收益率                    468906 non-null  float64       
     14  收盘价                    468906 non-null  float64       
     15  账面市值比                  468020 non-null  float64       
     16  12个月换手率_winsorized     468906 non-null  float64       
     17  20日换手率_winsorized      468906 non-null  float64       
     18  PB_winsorized          468906 non-null  float64       
     19  ROA_winsorized         463173 non-null  float64       
     20  ROE_winsorized         468906 non-null  float64       
     21  动量11_winsorized        467478 non-null  float64       
     22  动量6_winsorized         452414 non-null  float64       
     23  市值_winsorized          468906 non-null  float64       
     24  年化波动率_winsorized       402545 non-null  float64       
     25  总资产增长率_winsorized      465229 non-null  float64       
     26  收盘价_winsorized         468906 non-null  float64       
     27  账面市值比_winsorized       468149 non-null  float64       
     28  MonRf                  468906 non-null  float64       
     29  mk_rf                  468906 non-null  float64       
     30  收益率_rf                 468906 non-null  float64       
     31  groupby_市值_winsorized  468906 non-null  int64         
     32  groupby_市值             468906 non-null  int64         
     33  groupby_ROE            468850 non-null  float64       
     34  groupby_账面市值比          468020 non-null  float64       
     35  groupby_总资产增长率         465130 non-null  float64       
     36  group5by_市值            468906 non-null  int64         
     37  group5by_账面市值比         468020 non-null  float64       
     38  group5by_ROE           468850 non-null  float64       
     39  group5by_总资产增长率        465130 non-null  float64       
     40  group_市值_账面市值比         468020 non-null  float64       
     41  group_市值_ROE           468850 non-null  float64       
     42  group_市值_总资产增长率        465130 non-null  float64       
    dtypes: datetime64[ns](1), float64(37), int64(3), object(2)
    memory usage: 153.8+ MB



```python
def get_qc(s):
    s2 = s.copy()
    border_down1, border_up1 = s.quantile([0.3, 0.7])
    
    s2[s>=border_up1] = 3
    s2[(s>=border_down1) & (s<border_up1)] = 2
    s2[s<border_down1] = 1
    return s2
```


```python
data['市值大小分组'] = data.groupby("日期")['市值_winsorized'].apply(lambda x: pd.qcut(x, q=2, labels=range(1, 3)))
```


```python
data['账面市值比3070'] = data.groupby("日期")['账面市值比'].apply(lambda x: get_qc(x))
data['ROE3070'] = data.groupby("日期")['ROE'].apply(lambda x: get_qc(x))
data['总资产增长率3070'] = data.groupby("日期")['总资产增长率'].apply(lambda x: get_qc(x))
```


```python
data['3070_市值_账面市值比'] = data['市值大小分组'].astype("str") + data['账面市值比3070'].astype("str")
data['3070_市值_ROE'] = data['市值大小分组'].astype("str") + data['ROE3070'].astype("str")
data['3070_市值_总资产增长率'] = data['市值大小分组'].astype("str") + data['总资产增长率3070'].astype("str")
```


```python
import statsmodels.api as sm

def get_OLS(X, y):
    X = sm.add_constant(X)
    mod = sm.OLS(y, X)
    res = mod.fit()
    return res
```


```python
data['市值_winsorized_lag1'] = data.groupby("证券代码")['市值_winsorized'].shift(1)
data['账面市值比_winsorized_lag1'] = data.groupby("证券代码")['账面市值比_winsorized'].shift(1)
data['ROE_winsorized_lag1'] = data.groupby("证券代码")['ROE_winsorized'].shift(1)
data['总资产增长率_winsorized_lag1'] = data.groupby("证券代码")['总资产增长率_winsorized'].shift(1)
```


```python
portfolio_df = pd.DataFrame()

for col in ['3070_市值_账面市值比', '3070_市值_ROE', '3070_市值_总资产增长率']:
    _ = data.groupby(["日期", col])[['收益率', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']].mean().reset_index()
    _[col] = _[col].apply(lambda x: col + '_' + str(x))
    _.columns = ['日期', '投资组合', '收益率', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']
    portfolio_df = portfolio_df.append(_)
```


```python
portfolio_df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 4451 entries, 0 to 1525
    Data columns (total 7 columns):
     #   Column                  Non-Null Count  Dtype         
    ---  ------                  --------------  -----         
     0   日期                      4451 non-null   datetime64[ns]
     1   投资组合                    4451 non-null   object        
     2   收益率                     4451 non-null   float64       
     3   市值_winsorized_lag1      4413 non-null   float64       
     4   账面市值比_winsorized_lag1   4385 non-null   float64       
     5   ROE_winsorized_lag1     4413 non-null   float64       
     6   总资产增长率_winsorized_lag1  4313 non-null   float64       
    dtypes: datetime64[ns](1), float64(5), object(1)
    memory usage: 278.2+ KB



```python
portfolio_df_drop = portfolio_df.dropna()
```


```python
portfolio_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>投资组合</th>
      <th>收益率</th>
      <th>市值_winsorized_lag1</th>
      <th>账面市值比_winsorized_lag1</th>
      <th>ROE_winsorized_lag1</th>
      <th>总资产增长率_winsorized_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-06-30</td>
      <td>3070_市值_账面市值比_11.0</td>
      <td>-0.119331</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-06-30</td>
      <td>3070_市值_账面市值比_12.0</td>
      <td>1.644513</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-06-30</td>
      <td>3070_市值_账面市值比_13.0</td>
      <td>2.118344</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-06-30</td>
      <td>3070_市值_账面市值比_21.0</td>
      <td>2.055224</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-06-30</td>
      <td>3070_市值_账面市值比_22.0</td>
      <td>2.922307</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
factor_ex = []

for i in list(portfolio_df_drop['日期'].unique()):
    _ = portfolio_df_drop[portfolio_df_drop['日期'] == i].copy()
    
    X = _[['市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']]
    y = _['收益率']
    res = get_OLS(X, y)
    
    n = [i, *list(res.params.values)]
    factor_ex.append(n)
```


```python
df_ex = pd.DataFrame(factor_ex, columns=['日期', 'const', '市值因子收益率', '账面市值比因子收益率', 'ROE因子收益率', '总资产增长率因子收益率'])
```


```python
# df_ex.to_excel("因子收益率.xlsx", index=None)
```


```python
df_ex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>const</th>
      <th>市值因子收益率</th>
      <th>账面市值比因子收益率</th>
      <th>ROE因子收益率</th>
      <th>总资产增长率因子收益率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>11.893441</td>
      <td>-0.002794</td>
      <td>-2.176539</td>
      <td>0.119478</td>
      <td>-0.080916</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>7.524615</td>
      <td>-0.006606</td>
      <td>-2.273877</td>
      <td>0.064646</td>
      <td>-0.049349</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>1.640380</td>
      <td>-0.035452</td>
      <td>-1.264579</td>
      <td>0.089341</td>
      <td>-0.039572</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>6.209219</td>
      <td>-0.043229</td>
      <td>0.034465</td>
      <td>0.046475</td>
      <td>-0.051498</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>6.042043</td>
      <td>0.009037</td>
      <td>-0.012821</td>
      <td>0.060097</td>
      <td>-0.027767</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>229</th>
      <td>2019-08-30</td>
      <td>0.903615</td>
      <td>-0.003896</td>
      <td>-0.642187</td>
      <td>0.147248</td>
      <td>0.044357</td>
    </tr>
    <tr>
      <th>230</th>
      <td>2019-09-30</td>
      <td>-0.682817</td>
      <td>-0.002770</td>
      <td>0.041152</td>
      <td>0.046493</td>
      <td>0.088572</td>
    </tr>
    <tr>
      <th>231</th>
      <td>2019-10-31</td>
      <td>-0.131320</td>
      <td>0.009433</td>
      <td>-0.407243</td>
      <td>0.015681</td>
      <td>0.065441</td>
    </tr>
    <tr>
      <th>232</th>
      <td>2019-11-29</td>
      <td>-4.461443</td>
      <td>0.012130</td>
      <td>-0.179900</td>
      <td>-0.211728</td>
      <td>0.234640</td>
    </tr>
    <tr>
      <th>233</th>
      <td>2019-12-31</td>
      <td>7.923711</td>
      <td>0.003160</td>
      <td>-0.003607</td>
      <td>-0.006474</td>
      <td>0.026896</td>
    </tr>
  </tbody>
</table>
<p>234 rows × 6 columns</p>
</div>




```python
portfolio_dat = pd.DataFrame()

for col in ['group_市值_账面市值比', 'group_市值_ROE', 'group_市值_总资产增长率']:
    _ = data.groupby(["日期", col])[['收益率', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']].mean().reset_index()
    _[col] = _[col].apply(lambda x: col + '_' + str(x))
    _.columns = ['日期', '投资组合', '收益率', '市值_winsorized_lag1', '账面市值比_winsorized_lag1', 'ROE_winsorized_lag1', '总资产增长率_winsorized_lag1']
    portfolio_dat = portfolio_dat.append(_)
```


```python
portfolio_dat_f = portfolio_dat.merge(df_ex, on='日期', how='left').dropna()
```


```python
portfolio_dat_f.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 17550 entries, 25 to 17624
    Data columns (total 12 columns):
     #   Column                  Non-Null Count  Dtype         
    ---  ------                  --------------  -----         
     0   日期                      17550 non-null  datetime64[ns]
     1   投资组合                    17550 non-null  object        
     2   收益率                     17550 non-null  float64       
     3   市值_winsorized_lag1      17550 non-null  float64       
     4   账面市值比_winsorized_lag1   17550 non-null  float64       
     5   ROE_winsorized_lag1     17550 non-null  float64       
     6   总资产增长率_winsorized_lag1  17550 non-null  float64       
     7   const                   17550 non-null  float64       
     8   市值因子收益率                 17550 non-null  float64       
     9   账面市值比因子收益率              17550 non-null  float64       
     10  ROE因子收益率                17550 non-null  float64       
     11  总资产增长率因子收益率             17550 non-null  float64       
    dtypes: datetime64[ns](1), float64(10), object(1)
    memory usage: 1.7+ MB



```python
portfolio_dat_f['预期收益率'] = portfolio_dat_f['const'] + portfolio_dat_f['市值_winsorized_lag1'] * portfolio_dat_f['市值因子收益率'] \
 + portfolio_dat_f['账面市值比因子收益率'] * portfolio_dat_f['账面市值比_winsorized_lag1'] \
 + portfolio_dat_f['ROE因子收益率'] * portfolio_dat_f['ROE_winsorized_lag1'] \
 + portfolio_dat_f['总资产增长率因子收益率'] * portfolio_dat_f['总资产增长率_winsorized_lag1'] 
```


```python
portfolio_dat_f['超额alpha'] = portfolio_dat_f['收益率'] - portfolio_dat_f['预期收益率']
```


```python
portfolio_dat_f.groupby("投资组合")['超额alpha'].mean()
```




    投资组合
    group_市值_ROE_11.0     -0.399732
    group_市值_ROE_12.0     -1.191234
    group_市值_ROE_13.0     -1.459240
    group_市值_ROE_14.0     -1.044795
    group_市值_ROE_15.0      0.352074
                             ...   
    group_市值_账面市值比_51.0    0.460013
    group_市值_账面市值比_52.0   -0.689678
    group_市值_账面市值比_53.0   -0.978982
    group_市值_账面市值比_54.0   -0.628010
    group_市值_账面市值比_55.0   -0.536544
    Name: 超额alpha, Length: 75, dtype: float64




```python
portfolio_dat_f.to_excel("75个投资组合.xlsx", index=None)
```
