```python
import numpy as np
import pandas as pd
import os
```


```python
factor_df = pd.read_excel("五因子数据.xlsx")
factor_df = factor_df.rename(columns={"时间" : "日期"})
```


```python
factor_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>SMB</th>
      <th>HML</th>
      <th>CMA</th>
      <th>RMW</th>
      <th>mk_rf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>1.776700</td>
      <td>-2.048085</td>
      <td>-3.020902</td>
      <td>-3.910493</td>
      <td>4.985</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>2.161310</td>
      <td>-3.355225</td>
      <td>-2.356352</td>
      <td>-3.563212</td>
      <td>0.555</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>2.768764</td>
      <td>-0.595435</td>
      <td>-0.795055</td>
      <td>-0.294096</td>
      <td>-3.895</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>2.368923</td>
      <td>0.203406</td>
      <td>-1.691315</td>
      <td>-2.593286</td>
      <td>3.545</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>0.514857</td>
      <td>0.213481</td>
      <td>0.095284</td>
      <td>-0.527789</td>
      <td>6.015</td>
    </tr>
  </tbody>
</table>
</div>




```python
data = pd.read_excel("数据整理_2.xlsx")
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 468906 entries, 0 to 468905
    Data columns (total 43 columns):
     #   Column                 Non-Null Count   Dtype         
    ---  ------                 --------------   -----         
     0   证券名称                   468906 non-null  object        
     1   证券代码                   468906 non-null  object        
     2   日期                     468906 non-null  datetime64[ns]
     3   12个月换手率                468883 non-null  float64       
     4   20日换手率                 468883 non-null  float64       
     5   PB                     468904 non-null  float64       
     6   ROA                    462750 non-null  float64       
     7   ROE                    468850 non-null  float64       
     8   动量11                   466135 non-null  float64       
     9   动量6                    452273 non-null  float64       
     10  市值                     468906 non-null  float64       
     11  年化波动率                  402545 non-null  float64       
     12  总资产增长率                 465130 non-null  float64       
     13  收益率                    468906 non-null  float64       
     14  收盘价                    468906 non-null  float64       
     15  账面市值比                  468020 non-null  float64       
     16  12个月换手率_winsorized     468906 non-null  float64       
     17  20日换手率_winsorized      468906 non-null  float64       
     18  PB_winsorized          468906 non-null  float64       
     19  ROA_winsorized         463173 non-null  float64       
     20  ROE_winsorized         468906 non-null  float64       
     21  动量11_winsorized        467478 non-null  float64       
     22  动量6_winsorized         452414 non-null  float64       
     23  市值_winsorized          468906 non-null  float64       
     24  年化波动率_winsorized       402545 non-null  float64       
     25  总资产增长率_winsorized      465229 non-null  float64       
     26  收盘价_winsorized         468906 non-null  float64       
     27  账面市值比_winsorized       468149 non-null  float64       
     28  MonRf                  468906 non-null  float64       
     29  mk_rf                  468906 non-null  float64       
     30  收益率_rf                 468906 non-null  float64       
     31  groupby_市值_winsorized  468906 non-null  int64         
     32  groupby_市值             468906 non-null  int64         
     33  groupby_ROE            468850 non-null  float64       
     34  groupby_账面市值比          468020 non-null  float64       
     35  groupby_总资产增长率         465130 non-null  float64       
     36  group5by_市值            468906 non-null  int64         
     37  group5by_账面市值比         468020 non-null  float64       
     38  group5by_ROE           468850 non-null  float64       
     39  group5by_总资产增长率        465130 non-null  float64       
     40  group_市值_账面市值比         468020 non-null  float64       
     41  group_市值_ROE           468850 non-null  float64       
     42  group_市值_总资产增长率        465130 non-null  float64       
    dtypes: datetime64[ns](1), float64(37), int64(3), object(2)
    memory usage: 153.8+ MB



```python
portfolio_df = pd.DataFrame()
for col in ['group_市值_账面市值比', 'group_市值_ROE', 'group_市值_总资产增长率']:
    _ = data.groupby(["日期", col])['收益率'].mean().reset_index()
    _[col] = _[col].apply(lambda x: col + '_' + str(x))
    _.columns = ['日期', '投资组合', '收益率']
    portfolio_df = portfolio_df.append(_)
```


```python
len(portfolio_df.投资组合.unique())
```




    75




```python
portfolio_df_f = portfolio_df.merge(factor_df, on='日期', how='left').dropna()
```

# FM两步回归


```python
import statsmodels.api as sm

def get_OLS(X, y):
    X = sm.add_constant(X)
    mod = sm.OLS(y, X)
    res = mod.fit()
    return res
```


```python
factor_ex = []

for i in list(portfolio_df_f['投资组合'].unique()):
    _ = portfolio_df_f[portfolio_df_f['投资组合'] == i].copy().dropna(subset=['SMB', 'HML', 'CMA', 'RMW', '收益率'])
    X = _[['SMB', 'HML', 'CMA', 'RMW']]
    y = _['收益率']
    res = get_OLS(X, y)
    
    n = [i, *list(res.params.values)]
    factor_ex.append(n)
```


```python
df_ex = pd.DataFrame(factor_ex, columns=['投资组合', 'const', 'SMB_beta', 'HML_beta', 'CMA_beta', 'RMW_beta'])
```


```python
df_ex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>投资组合</th>
      <th>const</th>
      <th>SMB_beta</th>
      <th>HML_beta</th>
      <th>CMA_beta</th>
      <th>RMW_beta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>group_市值_账面市值比_11.0</td>
      <td>-0.882782</td>
      <td>1.237113</td>
      <td>-0.762328</td>
      <td>0.996820</td>
      <td>-1.138097</td>
    </tr>
    <tr>
      <th>1</th>
      <td>group_市值_账面市值比_12.0</td>
      <td>-1.228398</td>
      <td>1.314104</td>
      <td>-0.356283</td>
      <td>1.100764</td>
      <td>-1.222729</td>
    </tr>
    <tr>
      <th>2</th>
      <td>group_市值_账面市值比_13.0</td>
      <td>-1.194055</td>
      <td>1.450510</td>
      <td>-0.167005</td>
      <td>1.130098</td>
      <td>-1.183257</td>
    </tr>
    <tr>
      <th>3</th>
      <td>group_市值_账面市值比_14.0</td>
      <td>-1.310240</td>
      <td>1.752793</td>
      <td>0.288592</td>
      <td>0.786289</td>
      <td>-1.017192</td>
    </tr>
    <tr>
      <th>4</th>
      <td>group_市值_账面市值比_15.0</td>
      <td>-1.653910</td>
      <td>1.737540</td>
      <td>0.624126</td>
      <td>1.039594</td>
      <td>-1.221334</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>70</th>
      <td>group_市值_总资产增长率_51.0</td>
      <td>2.413053</td>
      <td>0.153535</td>
      <td>-0.278099</td>
      <td>0.178104</td>
      <td>-0.405299</td>
    </tr>
    <tr>
      <th>71</th>
      <td>group_市值_总资产增长率_52.0</td>
      <td>2.138295</td>
      <td>0.266977</td>
      <td>-0.079798</td>
      <td>0.288390</td>
      <td>-0.489346</td>
    </tr>
    <tr>
      <th>72</th>
      <td>group_市值_总资产增长率_53.0</td>
      <td>2.044595</td>
      <td>0.169824</td>
      <td>-0.056589</td>
      <td>0.502212</td>
      <td>-0.564405</td>
    </tr>
    <tr>
      <th>73</th>
      <td>group_市值_总资产增长率_54.0</td>
      <td>1.993046</td>
      <td>0.181597</td>
      <td>-0.187436</td>
      <td>0.932398</td>
      <td>-0.519933</td>
    </tr>
    <tr>
      <th>74</th>
      <td>group_市值_总资产增长率_55.0</td>
      <td>2.349673</td>
      <td>0.099702</td>
      <td>-0.804792</td>
      <td>1.776220</td>
      <td>-0.460928</td>
    </tr>
  </tbody>
</table>
<p>75 rows × 6 columns</p>
</div>




```python
ex_data = portfolio_df_f[['投资组合', '日期', '收益率']].merge(df_ex, on='投资组合', how='left').dropna(subset=['SMB_beta', 'HML_beta', 'CMA_beta', 'RMW_beta'])
```


```python
ex_data
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>投资组合</th>
      <th>日期</th>
      <th>收益率</th>
      <th>const</th>
      <th>SMB_beta</th>
      <th>HML_beta</th>
      <th>CMA_beta</th>
      <th>RMW_beta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>group_市值_账面市值比_11.0</td>
      <td>2000-07-31</td>
      <td>9.386252</td>
      <td>-0.882782</td>
      <td>1.237113</td>
      <td>-0.762328</td>
      <td>0.996820</td>
      <td>-1.138097</td>
    </tr>
    <tr>
      <th>1</th>
      <td>group_市值_账面市值比_12.0</td>
      <td>2000-07-31</td>
      <td>2.285166</td>
      <td>-1.228398</td>
      <td>1.314104</td>
      <td>-0.356283</td>
      <td>1.100764</td>
      <td>-1.222729</td>
    </tr>
    <tr>
      <th>2</th>
      <td>group_市值_账面市值比_13.0</td>
      <td>2000-07-31</td>
      <td>4.571372</td>
      <td>-1.194055</td>
      <td>1.450510</td>
      <td>-0.167005</td>
      <td>1.130098</td>
      <td>-1.183257</td>
    </tr>
    <tr>
      <th>3</th>
      <td>group_市值_账面市值比_14.0</td>
      <td>2000-07-31</td>
      <td>4.187239</td>
      <td>-1.310240</td>
      <td>1.752793</td>
      <td>0.288592</td>
      <td>0.786289</td>
      <td>-1.017192</td>
    </tr>
    <tr>
      <th>4</th>
      <td>group_市值_账面市值比_15.0</td>
      <td>2000-07-31</td>
      <td>0.705806</td>
      <td>-1.653910</td>
      <td>1.737540</td>
      <td>0.624126</td>
      <td>1.039594</td>
      <td>-1.221334</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17545</th>
      <td>group_市值_总资产增长率_51.0</td>
      <td>2019-12-31</td>
      <td>9.169028</td>
      <td>2.413053</td>
      <td>0.153535</td>
      <td>-0.278099</td>
      <td>0.178104</td>
      <td>-0.405299</td>
    </tr>
    <tr>
      <th>17546</th>
      <td>group_市值_总资产增长率_52.0</td>
      <td>2019-12-31</td>
      <td>7.412402</td>
      <td>2.138295</td>
      <td>0.266977</td>
      <td>-0.079798</td>
      <td>0.288390</td>
      <td>-0.489346</td>
    </tr>
    <tr>
      <th>17547</th>
      <td>group_市值_总资产增长率_53.0</td>
      <td>2019-12-31</td>
      <td>8.148702</td>
      <td>2.044595</td>
      <td>0.169824</td>
      <td>-0.056589</td>
      <td>0.502212</td>
      <td>-0.564405</td>
    </tr>
    <tr>
      <th>17548</th>
      <td>group_市值_总资产增长率_54.0</td>
      <td>2019-12-31</td>
      <td>9.024659</td>
      <td>1.993046</td>
      <td>0.181597</td>
      <td>-0.187436</td>
      <td>0.932398</td>
      <td>-0.519933</td>
    </tr>
    <tr>
      <th>17549</th>
      <td>group_市值_总资产增长率_55.0</td>
      <td>2019-12-31</td>
      <td>9.873377</td>
      <td>2.349673</td>
      <td>0.099702</td>
      <td>-0.804792</td>
      <td>1.776220</td>
      <td>-0.460928</td>
    </tr>
  </tbody>
</table>
<p>17550 rows × 8 columns</p>
</div>




```python
fa_prenium = []
for d in list(ex_data.日期.unique()):
    _ = ex_data[ex_data['日期'] == d].copy()
    X = _[['SMB_beta', 'HML_beta', 'CMA_beta', 'RMW_beta']]
    y = _['收益率']
    res = get_OLS(X, y)
    fa_prenium.append([d, *list(res.params.values)])
    print(d)
```


    2019-12-31T00:00:00.000000000



```python
df_pre = pd.DataFrame(fa_prenium, columns=['日期', 'const_a', 'SMB_溢价', 'HML_溢价', 'CMA_溢价', 'RMW_溢价'])
```


```python
df_pre.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>const_a</th>
      <th>SMB_溢价</th>
      <th>HML_溢价</th>
      <th>CMA_溢价</th>
      <th>RMW_溢价</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>5.170060</td>
      <td>-1.295977</td>
      <td>-2.481798</td>
      <td>-2.654102</td>
      <td>-3.561606</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-08-31</td>
      <td>-0.429398</td>
      <td>0.305494</td>
      <td>-3.402321</td>
      <td>-2.763531</td>
      <td>-3.194490</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-09-29</td>
      <td>-5.122759</td>
      <td>0.651224</td>
      <td>-1.505106</td>
      <td>-0.524761</td>
      <td>-0.922176</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-10-31</td>
      <td>0.911069</td>
      <td>1.396642</td>
      <td>-0.975250</td>
      <td>-1.368066</td>
      <td>-2.783161</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-11-30</td>
      <td>6.736969</td>
      <td>-1.280230</td>
      <td>-0.069436</td>
      <td>-0.311622</td>
      <td>-1.144004</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_pre.mean()
```

    <ipython-input-19-0b98a0662c22>:1: FutureWarning: DataFrame.mean and DataFrame.median with numeric_only=None will include datetime64 and datetime64tz columns in a future version.
      df_pre.mean()





    const_a    3.031886
    SMB_溢价    -0.707956
    HML_溢价    -0.071708
    CMA_溢价     0.116120
    RMW_溢价     1.025843
    dtype: float64




```python

```
