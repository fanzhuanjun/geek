# 0导入数据并整理为面板数据


```python
import pandas as pd
import numpy as np
import os
```


```python
list_stock = os.listdir("模型/")
list_market = os.listdir("da2/")

list_stock, list_market
```




    (['12个月换手率.xlsx',
      '20日换手率.xlsx',
      'PB.xlsx',
      'ROA.xlsx',
      'ROE.xlsx',
      '动量11.xlsx',
      '动量6.xlsx',
      '市值.xlsx',
      '年化波动率.xlsx',
      '总资产增长率.xlsx',
      '收益率.xlsx',
      '收盘价.xlsx',
      '账面市值比.xlsx'],
     ['市场收益率.xlsx', '无风险收益率.xlsx'])




```python
len(list_stock)
```




    13




```python
def get_final_data(path):
    df = pd.read_excel("模型/" + path)
    df.columns = list(df.loc[1].values)
    df = df.drop([0, 1]).T.reset_index().copy()
    df.columns = df.loc[0]
    
    df = df.drop(0, axis=0)
    _ = df.set_index(['日期', 'Date']).stack(dropna=False)
    _.name = path.split('.')[0]
    _ = _.reset_index()
    
    _.columns = ['证券名称', '证券代码', '日期', path.split('.')[0]]
    
    return _
```


```python
path = list_stock[0]
```


```python
df_final = get_final_data(list_stock[0])
for i in range(1, len(list_stock)):
    _ = get_final_data(list_stock[i])
    df_final = df_final.merge(_, on=['证券名称', '证券代码', '日期'], how='outer')

```


```python
len(df_final.columns)
```




    16




```python
X_cols = list(df_final.columns[3:])
```


```python
for col in X_cols:
    print(col)
    
    if col in ['ROA', '总资产增长率', '账面市值比']:
        df_final[col] = df_final[col].astype("str").replace("NaT", np.nan).astype("float")
    else:
        df_final[col] = df_final[col].astype("float")
```

    12个月换手率
    20日换手率
    PB
    ROA
    ROE
    动量11
    动量6
    市值
    年化波动率
    总资产增长率
    收益率
    收盘价
    账面市值比



```python
df_final.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 908880 entries, 0 to 908879
    Data columns (total 16 columns):
     #   Column   Non-Null Count   Dtype         
    ---  ------   --------------   -----         
     0   证券名称     908880 non-null  object        
     1   证券代码     908880 non-null  object        
     2   日期       908880 non-null  datetime64[ns]
     3   12个月换手率  473083 non-null  float64       
     4   20日换手率   473083 non-null  float64       
     5   PB       473106 non-null  float64       
     6   ROA      563761 non-null  float64       
     7   ROE      474711 non-null  float64       
     8   动量11     470303 non-null  float64       
     9   动量6      456282 non-null  float64       
     10  市值       473108 non-null  float64       
     11  年化波动率    405837 non-null  float64       
     12  总资产增长率   554122 non-null  float64       
     13  收益率      473111 non-null  float64       
     14  收盘价      473111 non-null  float64       
     15  账面市值比    573931 non-null  float64       
    dtypes: datetime64[ns](1), float64(13), object(2)
    memory usage: 117.9+ MB



```python
df_final_drop = df_final[df_final['收益率'].notnull()]
```


```python
df_final_drop.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 473111 entries, 0 to 908879
    Data columns (total 16 columns):
     #   Column   Non-Null Count   Dtype         
    ---  ------   --------------   -----         
     0   证券名称     473111 non-null  object        
     1   证券代码     473111 non-null  object        
     2   日期       473111 non-null  datetime64[ns]
     3   12个月换手率  473083 non-null  float64       
     4   20日换手率   473083 non-null  float64       
     5   PB       473106 non-null  float64       
     6   ROA      462750 non-null  float64       
     7   ROE      473039 non-null  float64       
     8   动量11     470303 non-null  float64       
     9   动量6      456282 non-null  float64       
     10  市值       473108 non-null  float64       
     11  年化波动率    405837 non-null  float64       
     12  总资产增长率   465130 non-null  float64       
     13  收益率      473111 non-null  float64       
     14  收盘价      473111 non-null  float64       
     15  账面市值比    468020 non-null  float64       
    dtypes: datetime64[ns](1), float64(13), object(2)
    memory usage: 61.4+ MB



```python
df_final_fill = df_final_drop.copy()
```


```python
df_final_fill['PB'] = df_final_fill.groupby("证券代码")['PB'].fillna(method='ffill')
df_final_fill['ROA'] = df_final_fill.groupby("证券代码")['ROA'].fillna(method='ffill')
df_final_fill['ROE'] = df_final_fill.groupby("证券代码")['ROE'].fillna(method='ffill')
df_final_fill['账面市值比'] = df_final_fill.groupby("证券代码")['账面市值比'].fillna(method='ffill')
```

## 缩尾处理：左右1%。将低于样本1%的用1%的数值赋值，大于99%的用99%赋值


```python
from scipy.stats.mstats import winsorize
# df4[col] = winsorize(df4[col], limits=[0.01,0.01])
```


```python
def using_mstats(s):
    return winsorize(s, limits=[0.01, 0.01])

# 非常好用的transform
for Value in X_cols:
    df_final_fill[f"{Value}_winsorized"] = df_final_fill.groupby('日期')[Value].transform(using_mstats)
```

# 1. 市场超额收益率


```python
list_market
```




    ['市场收益率.xlsx', '无风险收益率.xlsx']




```python
dat0 = pd.read_excel("da2/" + list_market[0])
dat1 = pd.read_excel("da2/" + list_market[1])
```


```python
dat0['Mreteq'].mean()
```




    0.01431625




```python
dat1['MonRf'].mean()
```




    0.2602320833333333




```python
dat0 = dat0.merge(dat1, on='Date')
```


```python
dat0['Mreteq'] = dat0['Mreteq'] * 100
```


```python
dat0['mk_rf'] = dat0['Mreteq'] - dat0['MonRf']
```


```python
dat0.columns = ['日期', 'Mreteq', 'MonRf', 'mk_rf']
```


```python
df_final_fill_me = df_final_fill.merge(dat0[['日期', 'MonRf', 'mk_rf']], how='left', on='日期')
```


```python
# df_final_fill_me['收益率_rf'] = df_final_fill_me['收益率_winsorized'] - df_final_fill_me['MonRf']
```


```python
df_final_fill_me[['收益率_rf', '收益率_winsorized']].corr()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>收益率_rf</th>
      <th>收益率_winsorized</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>收益率_rf</th>
      <td>1.000000</td>
      <td>0.999976</td>
    </tr>
    <tr>
      <th>收益率_winsorized</th>
      <td>0.999976</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_final_fill_me.to_excel("数据整理.xlsx", index=None)
```


```python

```
